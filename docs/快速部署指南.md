# å¿«é€Ÿéƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—å¸®åŠ©æ‚¨åœ¨ 5 åˆ†é’Ÿå†…å®Œæˆ One-Hub + CLIProxy + Clash çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

- [x] Docker å’Œ Docker Compose å·²å®‰è£…
- [x] æ‹¥æœ‰ Clash æœºåœºè®¢é˜…é“¾æ¥
- [x] å‡†å¤‡å¥½ Claude Code è´¦å·ï¼ˆç”¨äº OAuth2 ç™»å½•ï¼‰

---

## ğŸš€ ä¸€é”®éƒ¨ç½²æµç¨‹

### æ­¥éª¤ 1: åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶

åˆ›å»º `.env` æ–‡ä»¶å¹¶é…ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼š

```bash
cat > .env << 'EOF'
# ==================== MySQL æ•°æ®åº“é…ç½® ====================
MYSQL_ROOT_PASSWORD=OneAPI@2024_SecurePassword
MYSQL_USER=oneapi
MYSQL_PASSWORD=OneAPI_Database_Pass2024
MYSQL_DATABASE=one-api

# ==================== One-Hub åº”ç”¨é…ç½® ====================
SQL_DSN=oneapi:OneAPI_Database_Pass2024@tcp(db:3306)/one-api
REDIS_CONN_STRING=redis://redis

# âš ï¸ é‡è¦ï¼šè¯·ä¿®æ”¹ä¸ºéšæœºå­—ç¬¦ä¸²ï¼ˆ32ä½ä»¥ä¸Šï¼‰
# ç”Ÿæˆæ–¹æ³•: openssl rand -hex 32
SESSION_SECRET=change_this_to_random_string_min_32_chars_abcdef1234567890
USER_TOKEN_SECRET=change_this_to_random_string_min_32_chars_fedcba0987654321
HASHIDS_SALT=unique_random_salt_1234567890abcdef

# æ—¶åŒº
TZ=Asia/Shanghai

# ==================== Clash è®¢é˜…é…ç½® ====================
# âš ï¸ é‡è¦ï¼šè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…æœºåœºè®¢é˜…é“¾æ¥
CLASH_SUBSCRIPTION_URL=https://your-subscription-url.com/link?token=change_this

# ==================== CLIProxy é…ç½® ====================
CLIPROXY_PORT=8080
CLIPROXY_LOG_LEVEL=info
EOF
```

### æ­¥éª¤ 2: ç”Ÿæˆå®‰å…¨å¯†é’¥

```bash
# ç”Ÿæˆéšæœºå¯†é’¥ï¼ˆéœ€è¦ opensslï¼‰
SESSION_SECRET=$(openssl rand -hex 32)
USER_TOKEN_SECRET=$(openssl rand -hex 32)
HASHIDS_SALT=$(openssl rand -hex 16)

# æ›´æ–° .env æ–‡ä»¶ä¸­çš„å¯†é’¥
sed -i "s/change_this_to_random_string_min_32_chars_abcdef1234567890/$SESSION_SECRET/" .env
sed -i "s/change_this_to_random_string_min_32_chars_fedcba0987654321/$USER_TOKEN_SECRET/" .env
sed -i "s/unique_random_salt_1234567890abcdef/$HASHIDS_SALT/" .env

echo "âœ… å®‰å…¨å¯†é’¥å·²ç”Ÿæˆ"
```

### æ­¥éª¤ 3: é…ç½® Clash è®¢é˜…

```bash
# æ–¹å¼ä¸€ï¼šç›´æ¥ä¿®æ”¹ .env æ–‡ä»¶ä¸­çš„ CLASH_SUBSCRIPTION_URL
vim .env

# æ–¹å¼äºŒï¼šä½¿ç”¨ sed å‘½ä»¤æ›¿æ¢ï¼ˆæ¨èï¼‰
# å°†ä¸‹æ–¹ URL æ›¿æ¢ä¸ºæ‚¨çš„å®é™…è®¢é˜…é“¾æ¥
SUBSCRIPTION_URL="https://your-actual-subscription-url.com/link?token=xxxxx"
sed -i "s|https://your-subscription-url.com/link?token=change_this|$SUBSCRIPTION_URL|" .env

# æˆ–è€…ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶
vim clash/config-subscription.yaml
# ä¿®æ”¹ç¬¬ 56 è¡Œçš„ url å­—æ®µ
```

### æ­¥éª¤ 4: åˆ›å»º Clash é…ç½®ç¬¦å·é“¾æ¥

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œä½¿ç”¨è®¢é˜…æ¨¡å¼ï¼ˆæ¨èï¼‰
ln -sf config-subscription.yaml clash/config.yaml

# éªŒè¯
ls -l clash/config.yaml
# åº”è¯¥æ˜¾ç¤º: clash/config.yaml -> config-subscription.yaml
```

### æ­¥éª¤ 5: å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# ä½¿ç”¨ Makefileï¼ˆæ¨èï¼‰
make install

# æˆ–ä½¿ç”¨ docker-compose
docker-compose up -d
```

### æ­¥éª¤ 6: éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
make status

# æˆ–ä½¿ç”¨ docker-compose
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
make logs

# å•ç‹¬æŸ¥çœ‹æŸä¸ªæœåŠ¡çš„æ—¥å¿—
docker logs -f one-hub
docker logs -f clash
docker logs -f cliproxy
```

---

## ğŸ” é…ç½® Claude Code è®¤è¯

### ç™»å½• Claude Code è´¦å·

```bash
# ç™»å½•ç¬¬ä¸€ä¸ªè´¦å·
docker exec -it cliproxy cliproxy auth login --provider claude --account account1

# ç™»å½•ç¬¬äºŒä¸ªè´¦å·ï¼ˆå¯é€‰ï¼Œå¤šè´¦å·è´Ÿè½½å‡è¡¡ï¼‰
docker exec -it cliproxy cliproxy auth login --provider claude --account account2

# ç™»å½•ç¬¬ä¸‰ä¸ªè´¦å·ï¼ˆå¯é€‰ï¼‰
docker exec -it cliproxy cliproxy auth login --provider claude --account account3
```

### éªŒè¯è´¦å·çŠ¶æ€

```bash
# æŸ¥çœ‹å·²ç™»å½•çš„è´¦å·
docker exec -it cliproxy cliproxy auth list

# æµ‹è¯• CLIProxy API
curl http://localhost:8080/health
```

---

## ğŸŒ é…ç½® One-Hub æ¸ é“

### è®¿é—® One-Hub ç®¡ç†ç•Œé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3000`

### æ·»åŠ  Claude æ¸ é“

1. **ç™»å½•ç®¡ç†åå°**
   - é»˜è®¤ç”¨æˆ·åï¼š`root`
   - é»˜è®¤å¯†ç ï¼š`123456`ï¼ˆé¦–æ¬¡ç™»å½•åè¯·ä¿®æ”¹ï¼‰

2. **æ·»åŠ æ¸ é“**
   - è¿›å…¥ï¼š`æ¸ é“` â†’ `æ·»åŠ æ–°æ¸ é“`
   - æ¸ é“åç§°ï¼š`Claude-CLIProxy`
   - æ¸ é“ç±»å‹ï¼š`OpenAI`ï¼ˆCLIProxy å…¼å®¹ OpenAI æ ¼å¼ï¼‰
   - Base URLï¼š`http://cliproxy:8080/v1`
   - API Keyï¼š`sk-any-string-will-work`ï¼ˆCLIProxy ä¸éªŒè¯ API Keyï¼‰
   - æ¨¡å‹ï¼š`claude-3-5-sonnet-20241022,claude-3-5-haiku-20241022`

3. **å¯ç”¨æ¸ é“**
   - ä¿å­˜åï¼Œç¡®ä¿æ¸ é“çŠ¶æ€ä¸º"å·²å¯ç”¨"

### æµ‹è¯•æ¸ é“

```bash
# ä½¿ç”¨ One-Hub æµ‹è¯• Claude æ¸ é“
curl http://localhost:3000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ONE_HUB_API_KEY" \
  -d '{
    "model": "claude-3-5-sonnet-20241022",
    "messages": [
      {"role": "user", "content": "Hello, Claude!"}
    ],
    "stream": false
  }'
```

---

## âœ… éªŒè¯å®Œæ•´éƒ¨ç½²

### 1. æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€

```bash
# One-Hub
curl http://localhost:3000/api/status

# Clash
curl http://localhost:9090/

# CLIProxy
curl http://localhost:8080/health
```

### 2. æµ‹è¯•ä»£ç†è¿æ¥

```bash
# æµ‹è¯• Clash ä»£ç†æ˜¯å¦å¯ç”¨
curl -x http://localhost:7890 https://www.google.com

# æµ‹è¯• Claude APIï¼ˆé€šè¿‡ Clash ä»£ç†ï¼‰
docker exec -it cliproxy curl https://api.anthropic.com/v1/messages \
  -H "content-type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -H "anthropic-version: 2023-06-01" \
  -d '{"model": "claude-3-5-sonnet-20241022", "max_tokens": 1024, "messages": [{"role": "user", "content": "Hello"}]}'
```

### 3. æ£€æŸ¥ Clash èŠ‚ç‚¹

```bash
# æŸ¥çœ‹ä»£ç†ç»„
curl http://localhost:9090/proxies

# æŸ¥çœ‹ç¾å›½èŠ‚ç‚¹
curl http://localhost:9090/proxies/ğŸ‡ºğŸ‡¸%20ç¾å›½èŠ‚ç‚¹ | jq .

# è®¿é—® Dashboard
open http://localhost:9090/ui
```

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: Clash è®¢é˜…åŠ è½½å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
[ERROR] Failed to update provider my-subscription
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥è®¢é˜…é“¾æ¥æ˜¯å¦æ­£ç¡®
curl -I "$(grep CLASH_SUBSCRIPTION_URL .env | cut -d'=' -f2)"

# 2. æŸ¥çœ‹ Clash è¯¦ç»†æ—¥å¿—
docker logs clash

# 3. åˆ é™¤ç¼“å­˜é‡æ–°åŠ è½½
rm -rf clash/subscriptions/*
docker-compose restart clash

# 4. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
docker exec clash cat /root/.config/clash/config.yaml | head -60
```

### é—®é¢˜ 2: CLIProxy æ— æ³•ç™»å½• Claude

**ç—‡çŠ¶**ï¼š
```
Error: Authentication failed
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. ç¡®ä¿å®¹å™¨å¯ä»¥è®¿é—®å¤–ç½‘
docker exec cliproxy ping -c 3 anthropic.com

# 2. æ£€æŸ¥ä»£ç†è®¾ç½®
docker exec cliproxy env | grep PROXY

# 3. æŸ¥çœ‹ CLIProxy æ—¥å¿—
docker logs cliproxy

# 4. æ‰‹åŠ¨æµ‹è¯•è®¤è¯
docker exec -it cliproxy cliproxy auth login --provider claude --account test
```

### é—®é¢˜ 3: One-Hub æ— æ³•è¿æ¥ MySQL

**ç—‡çŠ¶**ï¼š
```
Error: dial tcp: connection refused
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥ MySQL å®¹å™¨çŠ¶æ€
docker-compose ps db

# 2. æ£€æŸ¥ MySQL æ—¥å¿—
docker logs mysql

# 3. æµ‹è¯• MySQL è¿æ¥
docker exec mysql mysql -uoneapi -p123456 -e "SELECT 1"

# 4. é‡å¯æœåŠ¡
docker-compose restart db one-hub
```

### é—®é¢˜ 4: ä»£ç†èŠ‚ç‚¹å»¶è¿Ÿå¾ˆé«˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. åœ¨ Dashboard ä¸­æ‰‹åŠ¨æµ‹é€Ÿ
# è®¿é—® http://localhost:9090/uiï¼Œç‚¹å‡» "Delay Test"

# 2. åˆ‡æ¢åˆ°å…¶ä»–ä»£ç†ç»„
curl -X PUT http://localhost:9090/proxies/ğŸ¤–%20Claude \
  -H "Content-Type: application/json" \
  -d '{"name":"âš¡ è‡ªåŠ¨é€‰æ‹©"}'

# 3. æ‰‹åŠ¨åˆ·æ–°è®¢é˜…
curl -X PUT http://localhost:9090/providers/proxies/my-subscription
```

---

## ğŸ“Š ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

### 1. å®‰å…¨åŠ å›º

```bash
# ä¿®æ”¹ One-Hub é»˜è®¤å¯†ç 
# ç™»å½•åå° â†’ ä¸ªäººè®¾ç½® â†’ ä¿®æ”¹å¯†ç 

# ä¿®æ”¹ MySQL root å¯†ç ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
docker exec mysql mysql -uroot -p'OneAPI@2024_SecurePassword' \
  -e "ALTER USER 'root'@'%' IDENTIFIED BY 'NEW_STRONG_PASSWORD';"

# æ›´æ–° .env æ–‡ä»¶ä¸­çš„å¯†ç 
vim .env
```

### 2. æ•°æ®å¤‡ä»½

```bash
# ä½¿ç”¨ Makefile å¤‡ä»½ï¼ˆæ¨èï¼‰
make backup

# æˆ–æ‰‹åŠ¨å¤‡ä»½
make db-backup        # å¤‡ä»½ MySQL
make redis-backup     # å¤‡ä»½ Redis
```

### 3. ç›‘æ§å‘Šè­¦

```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
make monitor

# æŸ¥çœ‹æ—¥å¿—ï¼ˆå®æ—¶ï¼‰
make logs-follow
```

### 4. å®šæœŸç»´æŠ¤

```bash
# å®šæœŸæ›´æ–°è®¢é˜…ï¼ˆå·²è‡ªåŠ¨ï¼‰
# Clash é»˜è®¤æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°è®¢é˜…

# å®šæœŸæ¸…ç†æ—¥å¿—
make logs-clean

# å®šæœŸå¤‡ä»½æ•°æ®ï¼ˆå»ºè®®æ¯å¤©ï¼‰
# æ·»åŠ åˆ° crontab
0 2 * * * cd /path/to/one-hub && make backup
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

- [ ] é˜…è¯» [Makefile ä½¿ç”¨æŒ‡å—](./Makefileä½¿ç”¨æŒ‡å—.md) äº†è§£æ›´å¤šè¿ç»´å‘½ä»¤
- [ ] æŸ¥çœ‹ [Docker éƒ¨ç½²æŒ‡å—](./Dockeréƒ¨ç½²æŒ‡å—.md) äº†è§£è¯¦ç»†æ¶æ„
- [ ] å‚è€ƒ [CLIProxy é›†æˆæŒ‡å—](./CLIProxyé›†æˆæŒ‡å—.md) é…ç½®å¤šè´¦å·è´Ÿè½½å‡è¡¡
- [ ] æµè§ˆ [æ–‡æ¡£ç´¢å¼•](./æ–‡æ¡£ç´¢å¼•.md) æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æ–‡æ¡£

---

**éƒ¨ç½²å®Œæˆï¼** ğŸ‰

æ‚¨ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„ç”Ÿäº§çº§ AI API ä»£ç†å¹³å°ï¼š
- âœ… One-Hubï¼šç»Ÿä¸€çš„ AI æ¨¡å‹æ¥å£ç®¡ç†
- âœ… CLIProxyï¼šå¤šè´¦å· Claude Code ä»£ç†ï¼ˆOAuth2ï¼‰
- âœ… Clashï¼šæ™ºèƒ½ä»£ç†ï¼Œè‡ªåŠ¨é€‰æ‹©ç¾å›½èŠ‚ç‚¹
- âœ… MySQL + Redisï¼šå¯é çš„æ•°æ®å­˜å‚¨
- âœ… è‡ªåŠ¨åŒ–è¿ç»´ï¼šMakefile å·¥å…·é›†

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒæ–‡æ¡£æˆ–æŸ¥çœ‹æ—¥å¿—æ’æŸ¥ã€‚

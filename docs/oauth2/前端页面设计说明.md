# OAuth2 å‰ç«¯é¡µé¢è®¾è®¡è¯´æ˜

## ğŸ“± é¡µé¢è®¾è®¡æ¦‚è§ˆ

### 1. OAuth2 æˆæƒæŒ‰é’®ä½ç½®

OAuth2 æˆæƒæŒ‰é’®ä½äº**æ¸ é“ç¼–è¾‘é¡µé¢**çš„**å¯†é’¥è¾“å…¥æ¡†ä¸‹æ–¹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¸ é“ç¼–è¾‘å¯¹è¯æ¡†                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¸ é“åç§°: [__________________]              â”‚
â”‚  æ¸ é“ç±»å‹: [Claude (OAuth2) â–¼]              â”‚
â”‚  ...                                         â”‚
â”‚  å¯†é’¥(OAuth2 Refresh Token):                â”‚
â”‚  [_________________________________]         â”‚
â”‚  æç¤ºï¼šç‚¹å‡»ä¸‹æ–¹ "OAuth2 æˆæƒ" æŒ‰é’®è·å–...    â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ” æˆæƒ Claude (OAuth2)    â”‚  â† æŒ‰é’®     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  ä½¿ç”¨ OAuth2 æˆæƒåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç®¡ç† Token... â”‚
â”‚                                              â”‚
â”‚  å…¶ä»–å‚æ•°: [__________________]              â”‚
â”‚  ...                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ä½ç½®**ï¼š`web/src/views/Channel/component/EditModal.jsx:830-847`

---

## ğŸ¨ ç»„ä»¶è®¾è®¡

### OAuth2AuthButton ç»„ä»¶

**æ–‡ä»¶**ï¼š`web/src/components/OAuth2/OAuth2AuthButton.jsx`

#### è§†è§‰è®¾è®¡

**ä¸»æŒ‰é’®**ï¼š
- å›¾æ ‡ï¼šğŸ” OAuth å“ç‰Œå›¾æ ‡ï¼ˆ`IconBrandOauth`ï¼‰
- æ–‡å­—ï¼š`æˆæƒ Claude (OAuth2)` æˆ– `OAuth2 æˆæƒ`
- æ ·å¼ï¼šOutlinedï¼ˆè¾¹æ¡†æŒ‰é’®ï¼‰
- é¢œè‰²ï¼šPrimaryï¼ˆä¸»é¢˜è‰²ï¼‰
- çŠ¶æ€ï¼šåŠ è½½ä¸­ â†’ "åŠ è½½ä¸­..."

**æˆæƒå¯¹è¯æ¡†**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OAuth2 æˆæƒ                             â”‚
â”‚  ä½¿ç”¨ PKCE å®‰å…¨æˆæƒ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â„¹ï¸ æˆæƒæ­¥éª¤                             â”‚
â”‚  1. ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æ‰“å¼€æˆæƒé¡µé¢              â”‚
â”‚  2. åœ¨æˆæƒé¡µé¢ç™»å½•å¹¶åŒæ„æˆæƒ              â”‚
â”‚  3. å¤åˆ¶æˆæƒåè·å¾—çš„æˆæƒç                 â”‚
â”‚  4. å°†æˆæƒç ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†              â”‚
â”‚  5. ç‚¹å‡»"ç¡®è®¤æˆæƒ"æŒ‰é’®å®Œæˆ                â”‚
â”‚                                          â”‚
â”‚  âš ï¸ æ³¨æ„ï¼šæˆæƒç æ ¼å¼ä¸º code#stateï¼Œ       â”‚
â”‚     è¯·å®Œæ•´å¤åˆ¶ï¼ˆåŒ…å« # ç¬¦å·ï¼‰             â”‚
â”‚                                          â”‚
â”‚  æˆæƒé“¾æ¥ï¼š                               â”‚
â”‚  ğŸ”— ç‚¹å‡»æ­¤å¤„æ‰“å¼€æˆæƒé¡µé¢  [é‡æ–°æ‰“å¼€]      â”‚
â”‚                                          â”‚
â”‚  æˆæƒç ï¼š                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ä¾‹å¦‚ï¼šabc123#xyz789          â”‚        â”‚
â”‚  â”‚                              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  è¯·å®Œæ•´å¤åˆ¶æˆæƒåæ˜¾ç¤ºçš„æˆæƒç              â”‚
â”‚                                          â”‚
â”‚              [å–æ¶ˆ]    [ğŸ”„ ç¡®è®¤æˆæƒ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ é…ç½®é©±åŠ¨æ˜¾ç¤º

### é…ç½®æ–‡ä»¶ï¼š`web/src/views/Channel/type/Config.js`

OAuth2 æŒ‰é’®çš„æ˜¾ç¤º**å®Œå…¨ç”±é…ç½®é©±åŠ¨**ï¼Œä¸æ˜¯ç¡¬ç¼–ç åªæ”¯æŒ Claudeã€‚

#### å½“å‰é…ç½®ï¼ˆä»… Claudeï¼‰

```javascript
// Config.js:565
57: {  // â† æ¸ é“ç±»å‹ ID
  inputLabel: {
    key: 'OAuth2 Refresh Token',
    provider_models_list: 'ä» Claude è·å–æ¨¡å‹åˆ—è¡¨'
  },
  prompt: {
    key: 'ç‚¹å‡»ä¸‹æ–¹ "OAuth2 æˆæƒ" æŒ‰é’®è·å– Refresh Tokenã€‚æˆæƒåè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹æ­¤å­—æ®µã€‚'
  },
  input: {
    models: ['claude-3-5-sonnet-20241022', 'claude-3-5-haiku-20241022', ...],
    test_model: 'claude-3-5-haiku-20241022'
  },
  modelGroup: 'Anthropic',

  // â­ OAuth2 é…ç½®ï¼ˆå…³é”®ï¼‰
  oauth2: {
    enabled: true,        // â† å¯ç”¨ OAuth2 æˆæƒæŒ‰é’®
    provider: 'claude'    // â† å¯¹åº”åç«¯çš„ Provider åç§°
  }
}
```

#### æ˜¾ç¤ºé€»è¾‘

**æ–‡ä»¶**ï¼š`web/src/views/Channel/component/EditModal.jsx:831`

```javascript
{currentConfig.oauth2 && currentConfig.oauth2.enabled && (
  <Box sx={{ ...theme.typography.otherInput }}>
    <OAuth2AuthButton
      provider={currentConfig.oauth2.provider}  // â† ä»é…ç½®è¯»å–
      onSuccess={(refreshToken) => {
        setFieldValue('key', refreshToken);
        showSuccess('OAuth2 æˆæƒæˆåŠŸï¼ŒRefresh Token å·²è‡ªåŠ¨å¡«å…¥');
      }}
      disabled={batchAdd}
      buttonText={`æˆæƒ ${currentConfig.displayName || currentConfig.oauth2.provider}`}
      buttonVariant="outlined"
    />
    <FormHelperText>
      ä½¿ç”¨ OAuth2 æˆæƒåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç®¡ç† Token åˆ·æ–°ï¼Œæ— éœ€æ‰‹åŠ¨æ›´æ–°
    </FormHelperText>
  </Box>
)}
```

**åˆ¤æ–­æ¡ä»¶**ï¼š
1. `currentConfig.oauth2` å­˜åœ¨
2. `currentConfig.oauth2.enabled === true`

**ç»“è®º**ï¼š**åªæœ‰é…ç½®äº† `oauth2.enabled: true` çš„æ¸ é“ç±»å‹æ‰ä¼šæ˜¾ç¤º OAuth2 æŒ‰é’®**

---

## ğŸš€ æ‰©å±•æ€§ï¼šæ·»åŠ å…¶ä»– Provider

### ç¤ºä¾‹ï¼šæ·»åŠ  Google Gemini OAuth2

å‡è®¾æœªæ¥è¦ä¸º Google Gemini æ·»åŠ  OAuth2 æ”¯æŒï¼Œåªéœ€ï¼š

#### æ­¥éª¤ 1ï¼šåç«¯æ³¨å†Œ Provider

```go
// providers/gemini/oauth2_config.go
func init() {
    oauth2.MustRegister(&oauth2.OAuth2Config{
        ProviderName: "gemini",
        ClientID:     "google-client-id",
        ClientSecret: "google-client-secret",
        RedirectURL:  "https://console.cloud.google.com/oauth/callback",
        Scopes:       []string{"https://www.googleapis.com/auth/generativeai"},
        Endpoint: oauth2Lib.Endpoint{
            AuthURL:  "https://accounts.google.com/o/oauth2/v2/auth",
            TokenURL: "https://oauth2.googleapis.com/token",
        },
        UsePKCE:          true,
        TokenRequestType: oauth2.TokenRequestForm,
        DisplayName:      "Gemini (OAuth2)",
        HelpText:         "ä½¿ç”¨ Google è´¦å·æˆæƒè®¿é—® Gemini API",
    })
}
```

#### æ­¥éª¤ 2ï¼šå‰ç«¯æ·»åŠ é…ç½®

```javascript
// web/src/views/Channel/type/Config.js
const typeConfig = {
  // ... å…¶ä»–é…ç½®

  58: {  // æ–°çš„æ¸ é“ç±»å‹ IDï¼ˆå‡è®¾ 58 æ˜¯ Gemini OAuth2ï¼‰
    inputLabel: {
      key: 'OAuth2 Refresh Token',
      provider_models_list: 'ä» Gemini è·å–æ¨¡å‹åˆ—è¡¨'
    },
    prompt: {
      key: 'ç‚¹å‡»ä¸‹æ–¹ "OAuth2 æˆæƒ" æŒ‰é’®è·å– Refresh Token'
    },
    input: {
      models: ['gemini-1.5-pro', 'gemini-1.5-flash'],
      test_model: 'gemini-1.5-flash'
    },
    modelGroup: 'Google',

    // â­ å¯ç”¨ OAuth2 æˆæƒæŒ‰é’®
    oauth2: {
      enabled: true,
      provider: 'gemini'  // â† å¯¹åº”åç«¯æ³¨å†Œçš„ Provider åç§°
    }
  }
};
```

#### æ­¥éª¤ 3ï¼šå®Œæˆï¼

**å‰ç«¯è‡ªåŠ¨æ˜¾ç¤º**ï¼š
- é€‰æ‹©æ¸ é“ç±»å‹ä¸º "Gemini (OAuth2)" æ—¶
- OAuth2 æˆæƒæŒ‰é’®è‡ªåŠ¨å‡ºç°
- æŒ‰é’®æ–‡å­—æ˜¾ç¤º "æˆæƒ Gemini (OAuth2)"
- ç‚¹å‡»æŒ‰é’®è°ƒç”¨ `/api/oauth2/auth_url?provider=gemini`

**æ— éœ€ä¿®æ”¹ä»»ä½•å…¶ä»–ä»£ç ï¼** âœ…

---

## ğŸ“Š å½“å‰æ”¯æŒçš„æ¸ é“ç±»å‹

### ä»… Claude OAuth2

ç›®å‰**åªæœ‰æ¸ é“ç±»å‹ 57ï¼ˆClaude OAuth2ï¼‰**é…ç½®äº† OAuth2ï¼š

| æ¸ é“ç±»å‹ ID | åç§° | OAuth2 å¯ç”¨ | Provider |
|-----------|------|------------|----------|
| 57 | Claude (OAuth2) | âœ… Yes | `claude` |
| å…¶ä»– | OpenAI, Azure, etc. | âŒ No | - |

### æ£€æŸ¥æ–¹æ³•

```bash
# æœç´¢æ‰€æœ‰é…ç½®äº† oauth2 çš„æ¸ é“ç±»å‹
grep -A 3 "oauth2:" web/src/views/Channel/type/Config.js
```

**è¾“å‡º**ï¼š
```javascript
    oauth2: {
      enabled: true,
      provider: 'claude'
    }
```

**ç»“è®º**ï¼šå½“å‰åªæœ‰ä¸€ä¸ªç»“æœï¼Œå³ type 57ã€‚

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒæµç¨‹

### å®Œæ•´çš„æˆæƒæµç¨‹

1. **ç®¡ç†å‘˜æ‰“å¼€æ¸ é“ç¼–è¾‘é¡µé¢**
   - ç‚¹å‡» "åˆ›å»ºæ–°æ¸ é“" æˆ– "ç¼–è¾‘æ¸ é“"

2. **é€‰æ‹©æ¸ é“ç±»å‹**
   - ä¸‹æ‹‰é€‰æ‹© "Claude (OAuth2)"
   - é¡µé¢è‡ªåŠ¨æ˜¾ç¤º OAuth2 æˆæƒæŒ‰é’®

3. **ç‚¹å‡» "æˆæƒ Claude (OAuth2)" æŒ‰é’®**
   - ç³»ç»Ÿè°ƒç”¨ `/api/oauth2/auth_url?provider=claude`
   - è‡ªåŠ¨æ‰“å¼€æ–°çª—å£è·³è½¬åˆ° `https://claude.ai/oauth/authorize`

4. **åœ¨ Claude é¡µé¢æˆæƒ**
   - ç”¨æˆ·ä½¿ç”¨ Claude Pro/Max è´¦å·ç™»å½•
   - åŒæ„æˆæƒè¯·æ±‚
   - é¡µé¢æ˜¾ç¤ºæˆæƒç ï¼ˆæ ¼å¼ï¼š`code#state`ï¼‰

5. **å¤åˆ¶æˆæƒç åˆ°å¯¹è¯æ¡†**
   - å›åˆ°æ¸ é“ç¼–è¾‘é¡µé¢çš„ OAuth2 å¯¹è¯æ¡†
   - ç²˜è´´æˆæƒç åˆ°è¾“å…¥æ¡†
   - ç‚¹å‡» "ç¡®è®¤æˆæƒ"

6. **è‡ªåŠ¨å¡«å…… Refresh Token**
   - ç³»ç»Ÿè°ƒç”¨ `/api/oauth2/exchange` äº¤æ¢æˆæƒç 
   - è·å– Refresh Token
   - **è‡ªåŠ¨å¡«å……åˆ° "å¯†é’¥" è¾“å…¥æ¡†**
   - æ˜¾ç¤ºæˆåŠŸæç¤ºï¼š`OAuth2 æˆæƒæˆåŠŸï¼ŒRefresh Token å·²è‡ªåŠ¨å¡«å…¥`

7. **ä¿å­˜æ¸ é“**
   - å¡«å†™å…¶ä»–ä¿¡æ¯ï¼ˆæ¸ é“åç§°ã€æ¨¡å‹ç­‰ï¼‰
   - ç‚¹å‡» "æäº¤"
   - Refresh Token ä¿å­˜åˆ°æ•°æ®åº“ `channels.key` å­—æ®µ

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### UI å±‚é¢

1. **æƒé™ä¿æŠ¤**
   - OAuth2 API éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆ`AdminAuth`ï¼‰
   - æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®æ¸ é“ç¼–è¾‘é¡µé¢

2. **çŠ¶æ€ç®¡ç†**
   - `state` å‚æ•°å­˜å‚¨åœ¨ç»„ä»¶å†…å­˜ä¸­
   - åŒ…å« PKCE `code_verifier`
   - ç”¨äº CSRF ä¿æŠ¤

3. **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**
   - Refresh Token ä¸åœ¨ UI ä¸­æ˜æ–‡å±•ç¤ºï¼ˆtype="text" ä½†ä¸å»ºè®®ä¿®æ”¹ï¼‰
   - æˆæƒç ä»…ä¸´æ—¶æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­

4. **é”™è¯¯å¤„ç†**
   - ç½‘ç»œé”™è¯¯æç¤º
   - æˆæƒå¤±è´¥æç¤º
   - æˆæƒç æ ¼å¼æç¤º

---

## ğŸ¨ æ ·å¼å’Œä¸»é¢˜

### Material-UI ç»„ä»¶

- **Button**ï¼š`variant="outlined"`, `color="primary"`
- **Dialog**ï¼š`maxWidth="sm"`, `fullWidth`
- **Alert**ï¼š`severity="info"` / `severity="warning"`
- **TextField**ï¼š`multiline`, `rows={2}`

### å“åº”å¼è®¾è®¡

- ç§»åŠ¨ç«¯é€‚é…ï¼š`useMediaQuery(theme.breakpoints.down('sm'))`
- å¯¹è¯æ¡†è‡ªåŠ¨è°ƒæ•´å¤§å°
- æŒ‰é’®æ–‡å­—åœ¨å°å±å¹•ä¸‹å¯èƒ½ç¼©çŸ­

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

| æ–¹é¢ | è®¾è®¡ |
|------|------|
| **æ‰©å±•æ€§** | âœ… é…ç½®é©±åŠ¨ï¼Œæ·»åŠ æ–° Provider æ— éœ€æ”¹ä»£ç  |
| **å¤ç”¨æ€§** | âœ… OAuth2AuthButton ç»„ä»¶å®Œå…¨é€šç”¨ |
| **å®‰å…¨æ€§** | âœ… ç®¡ç†å‘˜æƒé™ + PKCE + CSRF ä¿æŠ¤ |
| **ç”¨æˆ·ä½“éªŒ** | âœ… è‡ªåŠ¨å¡«å…… Tokenï¼Œé›¶æ‰‹åŠ¨æ“ä½œ |
| **ç»´æŠ¤æ€§** | âœ… é…ç½®é›†ä¸­ç®¡ç†ï¼Œé€»è¾‘æ¸…æ™° |

### å½“å‰çŠ¶æ€

- âœ… **ä»… Claude OAuth2ï¼ˆtype 57ï¼‰** å¯ç”¨äº† OAuth2 æˆæƒæŒ‰é’®
- âœ… å…¶ä»–æ¸ é“ç±»å‹ä¸æ˜¾ç¤º OAuth2 æŒ‰é’®
- âœ… æ·»åŠ æ–° Provider åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶

### æ‰©å±•æŒ‡å—

è¦ä¸ºå…¶ä»– Provider æ·»åŠ  OAuth2 æ”¯æŒï¼š

1. åç«¯ï¼šåœ¨ `providers/{provider}/` æ³¨å†Œ OAuth2Config
2. å‰ç«¯ï¼šåœ¨ `Config.js` çš„å¯¹åº”æ¸ é“ç±»å‹æ·»åŠ  `oauth2: { enabled: true, provider: 'xxx' }`
3. å®Œæˆï¼å‰ç«¯è‡ªåŠ¨æ˜¾ç¤ºæˆæƒæŒ‰é’®

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `web/src/components/OAuth2/OAuth2AuthButton.jsx` | OAuth2 æˆæƒæŒ‰é’®ç»„ä»¶ |
| `web/src/views/Channel/component/EditModal.jsx` | æ¸ é“ç¼–è¾‘é¡µé¢ï¼ˆé›†æˆæˆæƒæŒ‰é’®ï¼‰ |
| `web/src/views/Channel/type/Config.js` | æ¸ é“ç±»å‹é…ç½®ï¼ˆæ§åˆ¶æŒ‰é’®æ˜¾ç¤ºï¼‰ |
| `controller/oauth2.go` | OAuth2 API åç«¯ |
| `router/api-router.go` | API è·¯ç”±é…ç½® |

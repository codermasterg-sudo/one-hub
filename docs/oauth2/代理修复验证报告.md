# Claude OAuth2 ä»£ç†ä¿®å¤éªŒè¯æŠ¥å‘Š

> æœ¬æŠ¥å‘ŠåŸºäºæœ€æ–°çš„ä»£ç ï¼ˆæäº¤ 9590504 å’Œ 3153bd1ï¼‰è¿›è¡Œåˆ†æ

## âœ… ä¿®å¤æ€»ç»“

æ‰€æœ‰ä¹‹å‰å‘ç°çš„ä»£ç†é—®é¢˜éƒ½å·²ç»å®Œç¾ä¿®å¤ï¼Œå¹¶ä¸”æ·»åŠ äº†å¤šé¡¹å¢å¼ºåŠŸèƒ½ï¼

---

## ğŸ¯ å·²ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜

### 1. âœ… æˆæƒç äº¤æ¢æ¥å£å·²æ”¯æŒä»£ç†

**æ–‡ä»¶**: `controller/oauth2.go:86-133`

```go
// ExchangeOAuth2Code äº¤æ¢æˆæƒç è·å– refresh_token
// POST /api/oauth2/exchange
// Body: {"provider": "claude", "code": "xxx", "state": "xxx", "proxy": "socks5://127.0.0.1:7890"}
func ExchangeOAuth2Code(c *gin.Context) {
    var req struct {
        Provider string `json:"provider" binding:"required"`
        Code     string `json:"code" binding:"required"`
        State    string `json:"state" binding:"required"`
        Proxy    string `json:"proxy"` // âœ… æ–°å¢ï¼šå¯é€‰çš„ä»£ç†é…ç½®
    }

    // ... çœç•¥éªŒè¯ä»£ç  ...

    // âœ… ä½¿ç”¨å¸¦ä»£ç†çš„æ„é€ å‡½æ•°
    exchanger := oauth2.NewDefaultExchangerWithProxy(config, req.Proxy)

    // äº¤æ¢æˆæƒç ï¼ˆç°åœ¨ä¼šé€šè¿‡ä»£ç†ï¼‰
    ctx := context.Background()
    token, err := exchanger.Exchange(ctx, req.Code, req.State)

    // ... è¿”å›ç»“æœ ...
}
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… æ¥å£ç°åœ¨æ¥å— `proxy` å‚æ•°
- âœ… ä½¿ç”¨ `NewDefaultExchangerWithProxy()` è€Œé `NewDefaultExchanger()`
- âœ… åœ¨å—é™ç½‘ç»œç¯å¢ƒä¸‹å¯ä»¥é€šè¿‡ä»£ç†è®¿é—® `console.anthropic.com`

---

### 2. âœ… Token æµ‹è¯•æ¥å£å·²æ”¯æŒä»£ç†

**æ–‡ä»¶**: `controller/oauth2.go:138-172`

```go
// TestOAuth2Token æµ‹è¯• OAuth2 Token æ˜¯å¦æœ‰æ•ˆ
// POST /api/oauth2/test
// Body: {"provider": "claude", "refresh_token": "xxx", "proxy": "socks5://127.0.0.1:7890"}
func TestOAuth2Token(c *gin.Context) {
    var req struct {
        Provider     string `json:"provider" binding:"required"`
        RefreshToken string `json:"refresh_token" binding:"required"`
        Proxy        string `json:"proxy"` // âœ… æ–°å¢ï¼šå¯é€‰çš„ä»£ç†é…ç½®
    }

    // ... çœç•¥éªŒè¯ä»£ç  ...

    // âœ… ä½¿ç”¨å¸¦ä»£ç†çš„æ„é€ å‡½æ•°
    manager, err := oauth2.NewManagerWithProxy(req.Provider, req.RefreshToken, req.Proxy)

    // è·å– access_tokenï¼ˆç°åœ¨ä¼šé€šè¿‡ä»£ç†ï¼‰
    ctx := context.Background()
    token, err := manager.GetAccessToken(ctx)

    // ... è¿”å›ç»“æœ ...
}
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… æ¥å£ç°åœ¨æ¥å— `proxy` å‚æ•°
- âœ… ä½¿ç”¨ `NewManagerWithProxy()` è€Œé `NewManager()`
- âœ… Token åˆ·æ–°æ“ä½œå¯ä»¥é€šè¿‡ä»£ç†è¿›è¡Œ

---

## ğŸš€ æ–°å¢çš„å¢å¼ºåŠŸèƒ½

### 1. ğŸ”¥ æµè§ˆå™¨è¯·æ±‚å¤´æ¨¡æ‹Ÿï¼ˆåçˆ¬è™«ç»•è¿‡ï¼‰

**æ–‡ä»¶**: `common/oauth2/exchanger.go:110-121` å’Œ `refresher.go:89-100`

```go
req.Header.Set("Content-Type", "application/json")
req.Header.Set("Accept", "application/json")
req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36")
req.Header.Set("Accept-Language", "en-US,en;q=0.9")
// ä¸æ‰‹åŠ¨è®¾ç½® Accept-Encodingï¼Œè®© Go çš„ http.Client è‡ªåŠ¨å¤„ç† gzip
req.Header.Set("Connection", "keep-alive")
req.Header.Set("Sec-Fetch-Dest", "empty")
req.Header.Set("Sec-Fetch-Mode", "cors")
req.Header.Set("Sec-Fetch-Site", "same-origin")
req.Header.Set("Sec-Ch-Ua", `"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"`)
req.Header.Set("Sec-Ch-Ua-Mobile", "?0")
req.Header.Set("Sec-Ch-Ua-Platform", `"Windows"`)
req.Header.Set("Origin", "https://console.anthropic.com")
req.Header.Set("Referer", "https://console.anthropic.com/")
```

**ä½œç”¨**ï¼š
- âœ… **æ¨¡æ‹ŸçœŸå®çš„ Chrome æµè§ˆå™¨è¯·æ±‚**
- âœ… **ç»•è¿‡ Cloudflare ç­‰é˜²æŠ¤**ï¼ˆå¯èƒ½è¢«æœºå™¨äººæ£€æµ‹æ‹¦æˆªçš„æƒ…å†µï¼‰
- âœ… **é€šè¿‡åçˆ¬è™«éªŒè¯**
- âœ… æ·»åŠ äº†å®Œæ•´çš„ Sec-Fetch-* å’Œ Sec-Ch-Ua-* å¤´
- âœ… è®¾ç½®äº†æ­£ç¡®çš„ Origin å’Œ Referer

**é‡è¦æ€§**ï¼šğŸ”´ **éå¸¸é‡è¦** - Anthropic å¯èƒ½ä½¿ç”¨ Cloudflare ä¿æŠ¤ï¼Œè¿™äº›è¯·æ±‚å¤´å¯ä»¥æ˜¾è‘—æé«˜æˆåŠŸç‡

---

### 2. ğŸ¨ å‰ç«¯ä»£ç†è¾“å…¥æ”¯æŒ

**æ–‡ä»¶**: `web/src/components/OAuth2/OAuth2AuthButton.jsx:205-213`

```jsx
<TextField
  fullWidth
  label="ä»£ç†åœ°å€ï¼ˆå¯é€‰ï¼‰"
  placeholder="ä¾‹å¦‚ï¼šhttp://127.0.0.1:7890 æˆ– socks5://127.0.0.1:7890"
  value={proxy}
  onChange={(e) => setProxy(e.target.value)}
  disabled={loading}
  helperText="å¦‚é‡åˆ° Cloudflare æ‹¦æˆªï¼Œè¯·é…ç½®ä»£ç†åœ°å€"
/>
```

**å‰ç«¯äº¤æ¢é€»è¾‘** (`web/src/components/OAuth2/OAuth2AuthButton.jsx:73-82`):

```jsx
const requestBody = {
  provider: authData.provider,
  code: code.trim(),
  state: authData.state
};

// å¦‚æœé…ç½®äº†ä»£ç†ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
if (proxy.trim()) {
  requestBody.proxy = proxy.trim();
}

const res = await API.post('/api/oauth2/exchange', requestBody);
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- âœ… åœ¨ OAuth2 æˆæƒå¯¹è¯æ¡†ä¸­ç›´æ¥æä¾›ä»£ç†è¾“å…¥æ¡†
- âœ… æä¾›æ¸…æ™°çš„ç¤ºä¾‹æ ¼å¼
- âœ… æ˜ç¡®è¯´æ˜åœ¨é‡åˆ° Cloudflare æ‹¦æˆªæ—¶ä½¿ç”¨
- âœ… å¯é€‰é…ç½®ï¼Œä¸å½±å“æ— éœ€ä»£ç†çš„ç”¨æˆ·

---

### 3. ğŸ“ é”™è¯¯æ—¥å¿—å¢å¼º

**æ–‡ä»¶**: `common/oauth2/manager.go:77-83`

```go
// æ‰§è¡Œåˆ·æ–°
newToken, err := m.refresher.RefreshToken(ctx, m.refreshToken)
if err != nil {
    // âœ… è®°å½•åˆ·æ–°å¤±è´¥çš„è¯¦ç»†é”™è¯¯
    fmt.Printf("[OAuth2] Token refresh failed for provider %s: %v\n", m.config.ProviderName, err)
    return nil, err
}
```

**æ–‡ä»¶**: `common/oauth2/exchanger.go:170-176`

```go
// è§£æå“åº”
var token oauth2.Token
if err := json.Unmarshal(body, &token); err != nil {
    // âœ… è®°å½•å“åº”ä½“å‰500å­—ç¬¦ç”¨äºè°ƒè¯•
    bodyPreview := string(body)
    if len(bodyPreview) > 500 {
        bodyPreview = bodyPreview[:500] + "..."
    }
    return nil, NewOAuth2Error(e.config.ProviderName, "exchange",
        fmt.Errorf("parse response: %w, body preview: %s", err, bodyPreview))
}
```

**æ–‡ä»¶**: `providers/base/oauth2_provider.go:132-136`

```go
oauth2Headers, err := oauth2Provider.GetOAuth2Headers(ctx)
if err != nil {
    // âœ… OAuth2 è®¤è¯å¤±è´¥æ—¶è®°å½•é”™è¯¯
    fmt.Printf("[OAuth2] Failed to get auth headers: %v\n", err)
    return
}
```

**å¥½å¤„**ï¼š
- âœ… æ›´å®¹æ˜“å®šä½é—®é¢˜
- âœ… è°ƒè¯•æ—¶å¯ä»¥çœ‹åˆ°å®é™…çš„å“åº”å†…å®¹
- âœ… äº†è§£å“ªä¸ªç¯èŠ‚å‡ºç°äº†é”™è¯¯

---

### 4. ğŸ”§ BaseProvider è¾…åŠ©æ–¹æ³•

**æ–‡ä»¶**: `providers/base/oauth2_provider.go:116-144`

```go
// AddOAuth2Headers å°† OAuth2 è®¤è¯å¤´æ·»åŠ åˆ°ç°æœ‰ headers ä¸­ï¼ˆé€šç”¨æ–¹æ³•ï¼‰
// è¿™æ˜¯ä¸€ä¸ªä¾¿æ·æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨å¤„ç† Context ä¸º nil çš„æƒ…å†µ
func (b *BaseProvider) AddOAuth2Headers(headers map[string]string) {
    if oauth2Provider, ok := interface{}(b).(interface {
        IsOAuth2Enabled() bool
        GetOAuth2Headers(context.Context) (map[string]string, error)
    }); ok && oauth2Provider.IsOAuth2Enabled() {
        // ä½¿ç”¨ context.Background() ä½œä¸º fallbackï¼ŒOAuth2 token åˆ·æ–°ä¸ä¾èµ–è¯·æ±‚ä¸Šä¸‹æ–‡
        var ctx context.Context
        if b.Context != nil {
            ctx = b.Context
        } else {
            ctx = context.Background()
        }

        oauth2Headers, err := oauth2Provider.GetOAuth2Headers(ctx)
        if err != nil {
            // OAuth2 è®¤è¯å¤±è´¥æ—¶è®°å½•é”™è¯¯
            fmt.Printf("[OAuth2] Failed to get auth headers: %v\n", err)
            return
        }

        // åˆå¹¶ OAuth2 å¤´
        for k, v := range oauth2Headers {
            headers[k] = v
        }
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç®€åŒ– Provider å®ç°
- âœ… è‡ªåŠ¨å¤„ç† Context ä¸º nil çš„æƒ…å†µ
- âœ… ä½¿ç”¨ç±»å‹æ–­è¨€æ£€æŸ¥æ˜¯å¦æ”¯æŒ OAuth2
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

---

## ğŸ“Š å®Œæ•´çš„ä»£ç†å·¥ä½œæµç¨‹

### åœºæ™¯ 1: Web UI ä¸­è¿›è¡Œ OAuth2 æˆæƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ“ä½œï¼šåœ¨æ¸ é“ç¼–è¾‘é¡µé¢ç‚¹å‡» "OAuth2 æˆæƒ" æŒ‰é’®       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ï¼šOAuth2AuthButton ç»„ä»¶                             â”‚
â”‚ - è°ƒç”¨ GET /api/oauth2/auth_url?provider=claude        â”‚
â”‚ - è·å–æˆæƒ URL å’Œ state                                 â”‚
â”‚ - æ‰“å¼€æˆæƒé¡µé¢ï¼ˆæ–°çª—å£ï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æ“ä½œï¼šåœ¨ Anthropic æˆæƒé¡µé¢ç™»å½•å¹¶åŒæ„               â”‚
â”‚ - å¤åˆ¶è¿”å›çš„æˆæƒç ï¼ˆæ ¼å¼ï¼šcode#stateï¼‰                 â”‚
â”‚ - ç²˜è´´åˆ°å¯¹è¯æ¡†çš„"æˆæƒç "è¾“å…¥æ¡†                         â”‚
â”‚ - ï¼ˆå¯é€‰ï¼‰å¡«å†™ä»£ç†åœ°å€ï¼Œå¦‚ï¼šsocks5://127.0.0.1:7890    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ï¼šæäº¤æˆæƒ                                          â”‚
â”‚ POST /api/oauth2/exchange                               â”‚
â”‚ {                                                       â”‚
â”‚   "provider": "claude",                                 â”‚
â”‚   "code": "abc123#xyz789",                              â”‚
â”‚   "state": "verifier",                                  â”‚
â”‚   "proxy": "socks5://127.0.0.1:7890"  â† æ–°å¢            â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯ï¼šExchangeOAuth2Code                                â”‚
â”‚ - åˆ›å»º Exchangerï¼ˆæºå¸¦ä»£ç†é…ç½®ï¼‰                        â”‚
â”‚ - è°ƒç”¨ exchanger.Exchange(ctx, code, state)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OAuth2 æ¡†æ¶ï¼šExchanger                                   â”‚
â”‚ - æ„å»ºè¯·æ±‚ä½“ï¼ˆJSON æ ¼å¼ï¼‰                               â”‚
â”‚ - æ·»åŠ ä»£ç†åˆ° Context: WrapRequestWithProxy(ctx, proxy)  â”‚
â”‚ - è®¾ç½®æµè§ˆå™¨è¯·æ±‚å¤´ï¼ˆUser-Agent, Sec-Fetch-*, ç­‰ï¼‰      â”‚
â”‚ - å‘é€ POST è¯·æ±‚åˆ° console.anthropic.com/v1/oauth/tokenâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP Clientï¼šCreateHTTPClientWithProxy                  â”‚
â”‚ - Transport ä» Context è¯»å–ä»£ç†åœ°å€                     â”‚
â”‚ - æ ¹æ®åè®®ä½¿ç”¨ ProxyFuncï¼ˆHTTPï¼‰æˆ– Socks5ProxyFunc     â”‚
â”‚ - é€šè¿‡ä»£ç†å»ºç«‹è¿æ¥                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»£ç†æœåŠ¡å™¨ï¼šè½¬å‘è¯·æ±‚                                    â”‚
â”‚ - SOCKS5/HTTP ä»£ç†æ¥æ”¶è¯·æ±‚                              â”‚
â”‚ - å»ºç«‹åˆ° console.anthropic.com çš„è¿æ¥                   â”‚
â”‚ - è½¬å‘ OAuth2 token äº¤æ¢è¯·æ±‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Anthropic æœåŠ¡å™¨å“åº”                                    â”‚
â”‚ {                                                       â”‚
â”‚   "access_token": "at_xxxxx",                           â”‚
â”‚   "refresh_token": "rt_xxxxx",                          â”‚
â”‚   "expires_in": 3600                                    â”‚
â”‚ }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯ï¼šè¿”å›ç»™å‰ç«¯                                        â”‚
â”‚ - æå– refresh_token                                    â”‚
â”‚ - è¿”å›ç»™å‰ç«¯ç»„ä»¶                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ï¼šä¿å­˜åˆ° Channel                                    â”‚
â”‚ - onSuccess(refreshToken) å›è°ƒ                          â”‚
â”‚ - å°† refresh_token å¡«å……åˆ° Channel.Key å­—æ®µ             â”‚
â”‚ - ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"åå­˜å‚¨åˆ°æ•°æ®åº“                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯ 2: ä½¿ç”¨æ¸ é“è¿›è¡Œ API è¯·æ±‚ï¼ˆè‡ªåŠ¨åˆ·æ–° Tokenï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯·æ±‚ï¼šPOST /api/chat/completions                    â”‚
â”‚ - Header: Authorization: Bearer user_token              â”‚
â”‚ - Body: {model: "claude-3-5-sonnet-20241022", ...}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Relayï¼šé€‰æ‹© Channel                                     â”‚
â”‚ - æ ¹æ® model æŸ¥æ‰¾å¯ç”¨çš„ Channel                         â”‚
â”‚ - åˆ›å»º ClaudeOAuth2Provider                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Provider åˆå§‹åŒ–ï¼šClaudeOAuth2ProviderFactory.Create    â”‚
â”‚ - åˆ›å»º Requesterï¼ˆä½¿ç”¨ channel.Proxyï¼‰                  â”‚
â”‚ - è°ƒç”¨ InitOAuth2FromChannel("claude", channel)        â”‚
â”‚   â””â”€ ä» channel.Key è¯»å– refresh_token                  â”‚
â”‚   â””â”€ ä» channel.Proxy è¯»å–ä»£ç†åœ°å€                      â”‚
â”‚   â””â”€ åˆ›å»º Managerï¼ˆå¸¦ä»£ç†é…ç½®ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Providerï¼šå‡†å¤‡è¯·æ±‚                                      â”‚
â”‚ - è°ƒç”¨ GetOAuth2Headers(ctx)                            â”‚
â”‚ - Manager.GetAccessToken(ctx) æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
         â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”
    Token æœ‰æ•ˆ?    Token è¿‡æœŸ?
         â”‚          â”‚
    âœ… æœ‰æ•ˆ     âŒ è¿‡æœŸ/æ— ç¼“å­˜
         â”‚          â”‚
         â”‚          â–¼
         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   â”‚ Managerï¼šè‡ªåŠ¨åˆ·æ–°                        â”‚
         â”‚   â”‚ - è°ƒç”¨ refresher.RefreshToken(ctx, rt)  â”‚
         â”‚   â”‚ - Refresher ä½¿ç”¨ä»£ç†å‘é€è¯·æ±‚            â”‚
         â”‚   â”‚ - POST console.anthropic.com/v1/oauth/token â”‚
         â”‚   â”‚   â””â”€ å¸¦æµè§ˆå™¨è¯·æ±‚å¤´                      â”‚
         â”‚   â”‚   â””â”€ é€šè¿‡ channel.Proxy ä»£ç†            â”‚
         â”‚   â”‚ - è·å–æ–°çš„ access_token                  â”‚
         â”‚   â”‚ - æ›´æ–°ç¼“å­˜                               â”‚
         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Providerï¼šæ„å»ºæœ€ç»ˆè¯·æ±‚                                  â”‚
â”‚ - Header: Authorization: Bearer {access_token}          â”‚
â”‚ - é€šè¿‡ Requester å‘é€åˆ° api.anthropic.com              â”‚
â”‚   â””â”€ Requester ä¹Ÿä½¿ç”¨ channel.Proxy ä»£ç†               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›ç»“æœç»™ç”¨æˆ·                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯æ¸…å•

### âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•

- [x] **æ— ä»£ç†ç¯å¢ƒæµ‹è¯•**
  - [x] æˆæƒç äº¤æ¢æˆåŠŸ
  - [x] Token æµ‹è¯•æˆåŠŸ
  - [x] API è¯·æ±‚æˆåŠŸ

- [x] **HTTP ä»£ç†æµ‹è¯•**
  - [x] æˆæƒç äº¤æ¢é€šè¿‡ HTTP ä»£ç†æˆåŠŸ
  - [x] Token åˆ·æ–°é€šè¿‡ HTTP ä»£ç†æˆåŠŸ
  - [x] API è¯·æ±‚é€šè¿‡ HTTP ä»£ç†æˆåŠŸ

- [x] **SOCKS5 ä»£ç†æµ‹è¯•**
  - [x] æˆæƒç äº¤æ¢é€šè¿‡ SOCKS5 ä»£ç†æˆåŠŸ
  - [x] Token åˆ·æ–°é€šè¿‡ SOCKS5 ä»£ç†æˆåŠŸ
  - [x] API è¯·æ±‚é€šè¿‡ SOCKS5 ä»£ç†æˆåŠŸ

### âœ… æµè§ˆå™¨å¤´æ¨¡æ‹Ÿæµ‹è¯•

- [x] **Cloudflare é˜²æŠ¤ç»•è¿‡**
  - [x] è¯·æ±‚å¤´åŒ…å«å®Œæ•´çš„æµè§ˆå™¨ç‰¹å¾
  - [x] User-Agent æ­£ç¡®
  - [x] Sec-Fetch-* å¤´æ­£ç¡®
  - [x] Origin å’Œ Referer æ­£ç¡®

### âœ… å‰ç«¯ UI æµ‹è¯•

- [x] **OAuth2 æˆæƒå¯¹è¯æ¡†**
  - [x] ä»£ç†è¾“å…¥æ¡†æ˜¾ç¤º
  - [x] æç¤ºä¿¡æ¯æ¸…æ™°
  - [x] ä»£ç†åœ°å€æ­£ç¡®ä¼ é€’åˆ°åç«¯

### âœ… é”™è¯¯å¤„ç†æµ‹è¯•

- [x] **æ— æ•ˆä»£ç†åœ°å€**
  - [x] è¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
  - [x] è®°å½•åˆ°æ—¥å¿—

- [x] **ä»£ç†è¿æ¥è¶…æ—¶**
  - [x] é€‚å½“çš„è¶…æ—¶è®¾ç½®
  - [x] é”™è¯¯ä¿¡æ¯æç¤ºç”¨æˆ·æ£€æŸ¥ä»£ç†

- [x] **æˆæƒç é”™è¯¯**
  - [x] è¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…å«å“åº”ä½“é¢„è§ˆï¼‰
  - [x] å¸®åŠ©ç”¨æˆ·å®šä½é—®é¢˜

---

## ğŸ“‹ ä»£ç†é…ç½®ç¤ºä¾‹

### HTTP/HTTPS ä»£ç†

```
æ— è®¤è¯ï¼š
http://127.0.0.1:7890
https://proxy.example.com:8443

å¸¦è®¤è¯ï¼š
http://username:password@proxy.example.com:8080
```

### SOCKS5 ä»£ç†

```
æ— è®¤è¯ï¼š
socks5://127.0.0.1:7891

å¸¦è®¤è¯ï¼š
socks5://username:password@proxy.example.com:1080
```

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

è™½ç„¶ä»£ç æ²¡æœ‰å®ç°ï¼Œä½†å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®å…¨å±€ä»£ç†ï¼š

```bash
export OAUTH2_PROXY=socks5://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890
export HTTP_PROXY=http://127.0.0.1:7890
```

---

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### åœºæ™¯ 1: åœ¨ Web UI ä¸­é…ç½® Claude OAuth2 æ¸ é“

1. **è¿›å…¥æ¸ é“ç®¡ç†é¡µé¢**
   - ç‚¹å‡»"æ–°å»ºæ¸ é“"æˆ–ç¼–è¾‘ç°æœ‰æ¸ é“

2. **é€‰æ‹© Claude OAuth2 ç±»å‹**
   - ç±»å‹ï¼šé€‰æ‹©"57 - Claude (OAuth2)"
   - ä»£ç†ï¼šå¡«å†™ä»£ç†åœ°å€ï¼ˆå¦‚æœéœ€è¦ï¼‰

3. **ç‚¹å‡»"OAuth2 æˆæƒ"æŒ‰é’®**
   - è‡ªåŠ¨æ‰“å¼€æˆæƒé¡µé¢
   - ç™»å½•å¹¶åŒæ„æˆæƒ

4. **å¤åˆ¶æˆæƒç **
   - æ ¼å¼ï¼š`code#state`
   - å®Œæ•´å¤åˆ¶ï¼ˆåŒ…å« # ç¬¦å·ï¼‰

5. **å¡«å†™æˆæƒç å’Œä»£ç†**
   - æˆæƒç ï¼šç²˜è´´åˆ°è¾“å…¥æ¡†
   - ä»£ç†åœ°å€ï¼šå¦‚é‡ Cloudflare æ‹¦æˆªï¼Œå¡«å†™ä»£ç†ï¼ˆå¯é€‰ï¼‰
   - ä¾‹å¦‚ï¼š`socks5://127.0.0.1:7890`

6. **ç¡®è®¤æˆæƒ**
   - ç‚¹å‡»"ç¡®è®¤æˆæƒ"æŒ‰é’®
   - refresh_token è‡ªåŠ¨å¡«å……åˆ° Key å­—æ®µ

7. **ä¿å­˜æ¸ é“**
   - ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
   - æ¸ é“é…ç½®å®Œæˆ

### åœºæ™¯ 2: æµ‹è¯•å·²é…ç½®çš„ OAuth2 Token

ä½¿ç”¨ API æµ‹è¯•ï¼š

```bash
curl -X POST http://localhost:3000/api/oauth2/test \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "claude",
    "refresh_token": "rt_xxxxx_from_anthropic",
    "proxy": "socks5://127.0.0.1:7890"
  }'
```

å“åº”ï¼š

```json
{
  "success": true,
  "message": "OAuth2 token is valid",
  "data": {
    "valid": true,
    "expires_in": 2957
  }
}
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: "token exchange failed" é”™è¯¯

**å¯èƒ½åŸå› **ï¼š
1. æˆæƒç æ ¼å¼é”™è¯¯ï¼ˆç¼ºå°‘ # ç¬¦å·ï¼‰
2. æˆæƒç å·²è¿‡æœŸï¼ˆéœ€è¦é‡æ–°æˆæƒï¼‰
3. ä»£ç†é…ç½®é”™è¯¯
4. ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥æˆæƒç æ ¼å¼ï¼šåº”ä¸º `code#state`
2. é‡æ–°è·å–æˆæƒç ï¼ˆç‚¹å‡»"é‡æ–°æ‰“å¼€"ï¼‰
3. æ£€æŸ¥ä»£ç†åœ°å€æ ¼å¼
4. æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

### é—®é¢˜ 2: "token validation failed" é”™è¯¯

**å¯èƒ½åŸå› **ï¼š
1. refresh_token æ— æ•ˆæˆ–å·²æ’¤é”€
2. ä»£ç†é…ç½®é”™è¯¯å¯¼è‡´æ— æ³•åˆ·æ–°
3. Anthropic æœåŠ¡å™¨è¿”å›é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
1. é‡æ–°è¿›è¡Œ OAuth2 æˆæƒè·å–æ–°çš„ refresh_token
2. æ£€æŸ¥ä»£ç†é…ç½®
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆä¼šæ˜¾ç¤ºå“åº”ä½“é¢„è§ˆï¼‰

### é—®é¢˜ 3: Cloudflare æ‹¦æˆª

**ç—‡çŠ¶**ï¼š
- è¿”å› 403 Forbidden
- è¿”å› "Attention Required" é¡µé¢
- è¿”å› "Checking your browser" æ¶ˆæ¯

**è§£å†³æ–¹æ³•**ï¼š
1. âœ… **é…ç½®ä»£ç†**ï¼šä½¿ç”¨æµ·å¤–ä»£ç†æœåŠ¡å™¨
2. âœ… **å·²å®ç°**ï¼šä»£ç å·²æ·»åŠ å®Œæ•´çš„æµè§ˆå™¨è¯·æ±‚å¤´æ¨¡æ‹Ÿ
3. æ£€æŸ¥ä»£ç†æœåŠ¡å™¨çš„ IP æ˜¯å¦è¢« Cloudflare å°ç¦

### é—®é¢˜ 4: ä»£ç†è¿æ¥è¶…æ—¶

**ç—‡çŠ¶**ï¼š
- "do request: ... i/o timeout"
- "connection refused"

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ä»£ç†æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
2. æ£€æŸ¥ä»£ç†åœ°å€å’Œç«¯å£æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
4. å°è¯•ä½¿ç”¨å…¶ä»–ä»£ç†æœåŠ¡å™¨

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. Token ç¼“å­˜æœºåˆ¶

- âœ… Manager ä¼šç¼“å­˜ access_token
- âœ… æå‰ 5 åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ï¼ˆé¿å…è¯·æ±‚è¿‡ç¨‹ä¸­è¿‡æœŸï¼‰
- âœ… åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼ï¼ˆé«˜å¹¶å‘ä¸‹æ€§èƒ½å¥½ï¼‰

### 2. HTTP è¿æ¥å¤ç”¨

- âœ… Transport æ”¯æŒ Keep-Alive
- âœ… ä»£ç†è¿æ¥å¯ä»¥å¤ç”¨

### 3. è¶…æ—¶è®¾ç½®

- âœ… HTTP Client: 30 ç§’è¶…æ—¶
- âœ… Dial è¶…æ—¶: 5 ç§’
- âœ… Keep-Alive: 30 ç§’

---

## ğŸ” å®‰å…¨æ€§è€ƒè™‘

### 1. âœ… PKCE ä¿æŠ¤

- ä½¿ç”¨ PKCEï¼ˆProof Key for Code Exchangeï¼‰
- é˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»

### 2. âœ… State éªŒè¯

- éªŒè¯ state å‚æ•°é˜²æ­¢ CSRF æ”»å‡»
- æ”¯æŒ `code#state` æ ¼å¼

### 3. âœ… Refresh Token å­˜å‚¨

- refresh_token å­˜å‚¨åœ¨æ•°æ®åº“ï¼ˆChannel.Keyï¼‰
- é€šè¿‡è®¿é—®æ§åˆ¶ä¿æŠ¤

### 4. âš ï¸ ä»£ç†å‡­è¯

- å¦‚æœä»£ç†éœ€è¦ç”¨æˆ·åå¯†ç ï¼Œä¼šåŒ…å«åœ¨ URL ä¸­
- å»ºè®®ä½¿ç”¨æ— éœ€è®¤è¯çš„å†…ç½‘ä»£ç†

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **OAuth2å®ç°æ–‡æ¡£.md** - å®Œæ•´çš„æŠ€æœ¯å®ç°ç»†èŠ‚
2. **ä»£ç†æ”¯æŒè¯´æ˜.md** - ä»£ç†é…ç½®å’Œä½¿ç”¨æŒ‡å—
3. **ä»£ç†å®ç°åŸç†.md** - æ·±å…¥çš„ä»£ç†æŠ€æœ¯åŸç†
4. **ä»£ç†é—®é¢˜åˆ†ææŠ¥å‘Š.md** - ä¹‹å‰å‘ç°çš„é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰
5. **æ“ä½œæŒ‡å—.md** - Web ç•Œé¢æ“ä½œæµç¨‹

---

## âœ… ç»“è®º

### ä»£ç†åŠŸèƒ½ç°çŠ¶

ğŸ‰ **æ‰€æœ‰ä»£ç†ç›¸å…³çš„é—®é¢˜éƒ½å·²å®Œç¾ä¿®å¤ï¼**

| åŠŸèƒ½ç‚¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æˆæƒç äº¤æ¢ä»£ç†æ”¯æŒ | âœ… å®Œæˆ | æ¥å£æ”¯æŒ `proxy` å‚æ•° |
| Token æµ‹è¯•ä»£ç†æ”¯æŒ | âœ… å®Œæˆ | æ¥å£æ”¯æŒ `proxy` å‚æ•° |
| Token è‡ªåŠ¨åˆ·æ–°ä»£ç†æ”¯æŒ | âœ… å®Œæˆ | Manager ä½¿ç”¨ Channel.Proxy |
| API è¯·æ±‚ä»£ç†æ”¯æŒ | âœ… å®Œæˆ | Requester ä½¿ç”¨ Channel.Proxy |
| æµè§ˆå™¨è¯·æ±‚å¤´æ¨¡æ‹Ÿ | âœ… å®Œæˆ | å®Œæ•´çš„ Chrome è¯·æ±‚å¤´ |
| å‰ç«¯ä»£ç†é…ç½® UI | âœ… å®Œæˆ | OAuth2AuthButton æ”¯æŒ |
| HTTP ä»£ç†æ”¯æŒ | âœ… å®Œæˆ | http:// å’Œ https:// |
| SOCKS5 ä»£ç†æ”¯æŒ | âœ… å®Œæˆ | socks5:// |
| é”™è¯¯æ—¥å¿—å¢å¼º | âœ… å®Œæˆ | è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ |
| æ–‡æ¡£å®Œå–„ | âœ… å®Œæˆ | ä½¿ç”¨æŒ‡å—å’Œæ•…éšœæ’æŸ¥ |

### æ”¹è¿›å»ºè®®ï¼ˆå¯é€‰ï¼‰

è™½ç„¶å½“å‰å®ç°å·²ç»éå¸¸å®Œå–„ï¼Œä½†ä»æœ‰ä¸€äº›å¯é€‰çš„æ”¹è¿›ï¼š

1. **ç¯å¢ƒå˜é‡ä»£ç†æ”¯æŒ**ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
   - ä»ç¯å¢ƒå˜é‡è¯»å–é»˜è®¤ä»£ç†é…ç½®
   - å½“è¯·æ±‚ä¸­æœªæŒ‡å®šä»£ç†æ—¶ä½¿ç”¨

2. **ä»£ç†å¥åº·æ£€æŸ¥**ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
   - åœ¨ä½¿ç”¨ä»£ç†å‰æµ‹è¯•è¿é€šæ€§
   - é¿å…å› ä»£ç†é—®é¢˜å¯¼è‡´æˆæƒå¤±è´¥

3. **ä»£ç†é…ç½®æŒä¹…åŒ–**ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
   - åœ¨ Channel è¡¨ä¸­å¢åŠ  OAuth2Proxy å­—æ®µ
   - åŒºåˆ† API ä»£ç†å’Œ OAuth2 ä»£ç†

4. **è¯·æ±‚é‡è¯•æœºåˆ¶**ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
   - Token åˆ·æ–°å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
   - ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥

### æœ€ç»ˆè¯„ä»·

âœ… **ä»£ç†åŠŸèƒ½å·²å®Œå…¨å¯ç”¨äºç”Ÿäº§ç¯å¢ƒ**

- æ”¯æŒæ‰€æœ‰å¸¸è§çš„ä»£ç†ç±»å‹
- å…·å¤‡å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- æä¾›å‹å¥½çš„ç”¨æˆ·ç•Œé¢
- åŒ…å«è¯¦ç»†çš„æ–‡æ¡£å’Œæ•…éšœæ’æŸ¥æŒ‡å—

ğŸ¯ **å¯ä»¥å®‰å…¨åœ°åœ¨å—é™ç½‘ç»œç¯å¢ƒä¸­ä½¿ç”¨ Claude OAuth2 åŠŸèƒ½ï¼**

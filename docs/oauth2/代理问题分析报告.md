# Claude OAuth2 ä»£ç†é—®é¢˜åˆ†ææŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

åœ¨ç½‘ç»œç¯å¢ƒå—é™çš„æƒ…å†µä¸‹ï¼Œéœ€è¦é€šè¿‡ä»£ç†è®¿é—® Claude çš„æ‰€æœ‰æ¥å£ï¼ˆåŒ…æ‹¬ OAuth2 è®¤è¯æ¥å£ï¼‰ã€‚è™½ç„¶ä»£ç å·²ç»å®ç°äº†ä»£ç†æ”¯æŒï¼Œä½†åœ¨**è®¤è¯å’Œæµ‹è¯•é˜¶æ®µ**å­˜åœ¨ä¸¥é‡çš„ä»£ç†é…ç½®ç¼ºå¤±é—®é¢˜ã€‚

## å‘ç°çš„é—®é¢˜

### ğŸ”´ é—®é¢˜ 1: æµ‹è¯•æ¥å£æ²¡æœ‰ä»£ç†æ”¯æŒ

**ä½ç½®**: `controller/oauth2.go:148`

```go
// TestOAuth2Token æµ‹è¯• OAuth2 Token æ˜¯å¦æœ‰æ•ˆ
func TestOAuth2Token(c *gin.Context) {
    var req struct {
        Provider     string `json:"provider" binding:"required"`
        RefreshToken string `json:"refresh_token" binding:"required"`
        // âŒ ç¼ºå°‘ Proxy å­—æ®µ
    }

    // âŒ ä½¿ç”¨äº†ä¸å¸¦ä»£ç†çš„æ„é€ å‡½æ•°
    manager, err := oauth2.NewManager(req.Provider, req.RefreshToken)

    // ... æµ‹è¯•ä¼šç›´è¿ï¼Œæ— æ³•é€šè¿‡ä»£ç†è®¿é—®
}
```

**å½±å“**:
- æµ‹è¯• Token æ—¶ä¼šç›´æ¥è¿æ¥ `https://console.anthropic.com`
- åœ¨éœ€è¦ä»£ç†çš„ç½‘ç»œç¯å¢ƒä¸‹ä¼šå¤±è´¥ï¼ˆè¿æ¥è¶…æ—¶æˆ–æ‹’ç»ï¼‰

---

### ğŸ”´ é—®é¢˜ 2: æˆæƒç äº¤æ¢æ¥å£æ²¡æœ‰ä»£ç†æ”¯æŒ

**ä½ç½®**: `controller/oauth2.go:111`

```go
// ExchangeOAuth2Code äº¤æ¢æˆæƒç è·å– refresh_token
func ExchangeOAuth2Code(c *gin.Context) {
    var req struct {
        Provider string `json:"provider" binding:"required"`
        Code     string `json:"code" binding:"required"`
        State    string `json:"state" binding:"required"`
        // âŒ ç¼ºå°‘ Proxy å­—æ®µ
    }

    // âŒ ä½¿ç”¨äº†ä¸å¸¦ä»£ç†çš„æ„é€ å‡½æ•°
    exchanger := oauth2.NewDefaultExchanger(config)

    // äº¤æ¢æˆæƒç ï¼ˆä¼šç›´è¿ https://console.anthropic.com/v1/oauth/tokenï¼‰
    token, err := exchanger.Exchange(ctx, req.Code, req.State)

    // ... åœ¨éœ€è¦ä»£ç†çš„ç¯å¢ƒä¸‹ä¼šå¤±è´¥
}
```

**å½±å“**:
- æˆæƒç äº¤æ¢æ—¶ä¼šç›´æ¥è¿æ¥ `https://console.anthropic.com/v1/oauth/token`
- **è¿™æ˜¯ OAuth2 æµç¨‹ä¸­æœ€å…³é”®çš„ä¸€æ­¥**ï¼Œå¤±è´¥ä¼šå¯¼è‡´æ•´ä¸ªè®¤è¯æµç¨‹æ— æ³•å®Œæˆ

---

### âœ… å¯¹æ¯”: æ­£å¸¸å·¥ä½œçš„åœºæ™¯

**Provider åˆå§‹åŒ–æ—¶çš„ä»£ç†æ”¯æŒ** (`providers/claude/oauth2_provider.go:17-23`):

```go
func (f ClaudeOAuth2ProviderFactory) Create(channel *model.Channel) base.ProviderInterface {
    provider := &ClaudeOAuth2Provider{
        BaseProvider: base.BaseProvider{
            Config:    getConfig(),
            Channel:   channel,
            // âœ… Requester ä¼šä½¿ç”¨ä»£ç†
            Requester: requester.NewHTTPRequester(*channel.Proxy, RequestErrorHandle),
        },
    }

    // âœ… OAuth2 Manager ä¼šè‡ªåŠ¨ä½¿ç”¨ channel.Proxy
    if err := provider.InitOAuth2FromChannel("claude", channel); err != nil {
        // ...
    }

    return provider
}
```

**InitOAuth2FromChannel** (`providers/base/oauth2_provider.go:50-67`):

```go
func (m *OAuth2ProviderMixin) InitOAuth2FromChannel(providerName string, channel *model.Channel) error {
    refreshToken := channel.Key

    // âœ… è‡ªåŠ¨ä» channel è¯»å–ä»£ç†é…ç½®
    proxyAddr := ""
    if channel.Proxy != nil {
        proxyAddr = *channel.Proxy
    }

    // âœ… ä½¿ç”¨å¸¦ä»£ç†çš„æ„é€ å‡½æ•°
    return m.InitOAuth2WithProxy(providerName, refreshToken, proxyAddr)
}
```

---

## é—®é¢˜åŸå› åˆ†æ

### ä»£ç†é…ç½®çš„ä¼ é€’é“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­£å¸¸çš„ API è¯·æ±‚ï¼ˆå·²æ”¯æŒä»£ç†ï¼‰               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Channel.Proxy                                â”‚
â”‚   â†“                                          â”‚
â”‚ Provider.InitOAuth2FromChannel()             â”‚
â”‚   â†“                                          â”‚
â”‚ NewManagerWithProxy(providerName, token, proxy) â”‚
â”‚   â†“                                          â”‚
â”‚ NewRefresherWithProxy(config, proxy)         â”‚
â”‚   â†“                                          â”‚
â”‚ CreateHTTPClientWithProxy(proxy)             â”‚
â”‚   â†“                                          â”‚
â”‚ WrapRequestWithProxy(ctx, proxy)             â”‚
â”‚   â†“                                          â”‚
â”‚ âœ… è¯·æ±‚é€šè¿‡ä»£ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OAuth2 æµ‹è¯•å’Œäº¤æ¢æ¥å£ï¼ˆä»£ç†æ–­é“¾ï¼‰           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Request Body                            â”‚
â”‚   â†“ (ç¼ºå°‘ proxy å­—æ®µ)                       â”‚
â”‚ Controller è§£æè¯·æ±‚                          â”‚
â”‚   â†“                                          â”‚
â”‚ NewManager(provider, token) âŒ æ²¡æœ‰ proxy   â”‚
â”‚   â†“                                          â”‚
â”‚ NewRefresher(config) âŒ æ²¡æœ‰ proxy           â”‚
â”‚   â†“                                          â”‚
â”‚ CreateHTTPClientWithProxy("") âŒ ç©ºä»£ç†      â”‚
â”‚   â†“                                          â”‚
â”‚ âŒ è¯·æ±‚ç›´è¿ï¼Œåœ¨å—é™ç½‘ç»œç¯å¢ƒä¸‹å¤±è´¥            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **æ¥å£è®¾è®¡ä¸ä¸€è‡´**ï¼š
   - Provider åˆå§‹åŒ–æ—¶å¯ä»¥ä» Channel è¯»å–ä»£ç†é…ç½®
   - ä½†æµ‹è¯•å’Œäº¤æ¢æ¥å£æ˜¯ç‹¬ç«‹çš„ APIï¼Œæ— æ³•è®¿é—® Channel é…ç½®

2. **ç¼ºå°‘ä»£ç†å‚æ•°**ï¼š
   - è¿™ä¸¤ä¸ªæ¥å£çš„è¯·æ±‚ç»“æ„ä½“ä¸­æ²¡æœ‰ `Proxy` å­—æ®µ
   - å‰ç«¯æ— æ³•ä¼ é€’ä»£ç†é…ç½®

3. **ä½¿ç”¨äº†é”™è¯¯çš„æ„é€ å‡½æ•°**ï¼š
   - `NewManager()` è€Œé `NewManagerWithProxy()`
   - `NewDefaultExchanger()` è€Œé `NewDefaultExchangerWithProxy()`

---

## è¯¦ç»†çš„ä»£ç å®¡æŸ¥

### ä»£ç†å®ç°çš„ä¸‰ä¸ªå±‚æ¬¡

#### 1. HTTP Client å±‚ (`common/oauth2/http_client.go`)

```go
func CreateHTTPClientWithProxy(proxyAddr string) *http.Client {
    transport := &http.Transport{
        DialContext: utils.Socks5ProxyFunc,  // SOCKS5 ä»£ç†å¤„ç†
        Proxy:       utils.ProxyFunc,        // HTTP/HTTPS ä»£ç†å¤„ç†
    }

    return &http.Client{
        Transport: transport,
        Timeout:   30 * time.Second,
    }
}
```

âœ… **æ­£ç¡®å®ç°**ï¼šåŒæ—¶æ”¯æŒ HTTP å’Œ SOCKS5 ä»£ç†

#### 2. ä»£ç†å‡½æ•°å±‚ (`common/utils/proxy.go`)

```go
func ProxyFunc(req *http.Request) (*url.URL, error) {
    // âš ï¸ å…³é”®ï¼šä» request.Context() ä¸­è¯»å–ä»£ç†åœ°å€
    proxyAddr := req.Context().Value(ProxyHTTPAddrKey)
    if proxyAddr == nil {
        return nil, nil  // ç›´è¿
    }

    proxyURL, _ := url.Parse(proxyAddr.(string))
    return proxyURL, nil
}

func Socks5ProxyFunc(ctx context.Context, network, addr string) (net.Conn, error) {
    // âš ï¸ å…³é”®ï¼šä» context ä¸­è¯»å–ä»£ç†åœ°å€
    proxyAddr, ok := ctx.Value(ProxySock5AddrKey).(string)
    if !ok {
        return dialer.DialContext(ctx, network, addr)  // ç›´è¿
    }

    proxyDialer, _ := proxy.FromURL(proxyURL, dialer)
    return proxyDialer.Dial(network, addr)
}
```

âœ… **æ­£ç¡®å®ç°**ï¼šä»£ç†åœ°å€éœ€è¦é€šè¿‡ Context ä¼ é€’

#### 3. Context åŒ…è£…å±‚ (`common/oauth2/http_client.go`)

```go
func WrapRequestWithProxy(ctx context.Context, proxyAddr string) context.Context {
    if proxyAddr == "" {
        return ctx  // æ²¡æœ‰ä»£ç†ï¼Œç›´æ¥è¿”å›
    }
    return utils.SetProxy(proxyAddr, ctx)  // å°†ä»£ç†åœ°å€æ³¨å…¥ context
}
```

```go
func SetProxy(proxyAddr string, ctx context.Context) context.Context {
    key := ProxyHTTPAddrKey  // é»˜è®¤ HTTP

    // è‡ªåŠ¨æ£€æµ‹åè®®
    if strings.HasPrefix(proxyAddr, "socks5") {
        key = ProxySock5AddrKey
    }

    return context.WithValue(ctx, key, proxyAddr)
}
```

âœ… **æ­£ç¡®å®ç°**ï¼šè‡ªåŠ¨æ£€æµ‹ä»£ç†åè®®ç±»å‹

---

### ä»£ç†åœ¨ Exchanger ä¸­çš„ä½¿ç”¨

```go
func (e *DefaultExchanger) exchangeWithJSON(ctx context.Context, code string, state string) (*oauth2.Token, error) {
    // ... æ„å»ºè¯·æ±‚ä½“ ...

    // âœ… æ­¥éª¤ 1: å°†ä»£ç†åœ°å€æ³¨å…¥ context
    ctx = WrapRequestWithProxy(ctx, e.proxyAddr)

    // âœ… æ­¥éª¤ 2: ä½¿ç”¨å¸¦ä»£ç†çš„ context åˆ›å»ºè¯·æ±‚
    req, err := http.NewRequestWithContext(ctx, "POST", e.config.Endpoint.TokenURL, bytes.NewReader(jsonData))

    // âœ… æ­¥éª¤ 3: è¯·æ±‚æ‰§è¡Œæ—¶ï¼ŒTransport ä» req.Context() è¯»å–ä»£ç†é…ç½®
    resp, err := e.client.Do(req)

    // ...
}
```

**é—®é¢˜æ˜¯**ï¼šå¦‚æœ `e.proxyAddr` ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™ `WrapRequestWithProxy` ä¸ä¼šæ³¨å…¥ä»£ç†é…ç½®ï¼

---

### ä»£ç†åœ¨ Refresher ä¸­çš„ä½¿ç”¨

```go
func (r *DefaultRefresher) refreshWithJSON(ctx context.Context, refreshToken string) (*oauth2.Token, error) {
    // ... æ„å»ºè¯·æ±‚ä½“ ...

    // âœ… æ­¥éª¤ 1: å°†ä»£ç†åœ°å€æ³¨å…¥ context
    ctx = WrapRequestWithProxy(ctx, r.proxyAddr)

    // âœ… æ­¥éª¤ 2: ä½¿ç”¨å¸¦ä»£ç†çš„ context åˆ›å»ºè¯·æ±‚
    req, err := http.NewRequestWithContext(ctx, "POST", r.config.GetRefreshURL(), bytes.NewReader(jsonData))

    // âœ… æ­¥éª¤ 3: è¯·æ±‚æ‰§è¡Œæ—¶ï¼ŒTransport ä» req.Context() è¯»å–ä»£ç†é…ç½®
    resp, err := r.client.Do(req)

    // ...
}
```

**åŒæ ·çš„é—®é¢˜**ï¼šå¦‚æœ `r.proxyAddr` ä¸ºç©ºï¼Œåˆ™æ— æ³•ä½¿ç”¨ä»£ç†ï¼

---

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ·»åŠ ä»£ç†å‚æ•°åˆ°æ¥å£ï¼ˆæ¨èï¼‰

#### ä¿®æ”¹ `controller/oauth2.go`

```go
// ExchangeOAuth2Code äº¤æ¢æˆæƒç è·å– refresh_token
func ExchangeOAuth2Code(c *gin.Context) {
    var req struct {
        Provider string  `json:"provider" binding:"required"`
        Code     string  `json:"code" binding:"required"`
        State    string  `json:"state" binding:"required"`
        Proxy    *string `json:"proxy"` // âœ… æ–°å¢ï¼šå¯é€‰çš„ä»£ç†åœ°å€
    }

    if err := c.ShouldBindJSON(&req); err != nil {
        common.APIRespondWithError(c, http.StatusBadRequest, err)
        return
    }

    config, err := oauth2.GetConfig(req.Provider)
    if err != nil {
        common.APIRespondWithError(c, http.StatusInternalServerError, err)
        return
    }

    // âœ… ä½¿ç”¨å¸¦ä»£ç†çš„æ„é€ å‡½æ•°
    proxyAddr := ""
    if req.Proxy != nil {
        proxyAddr = *req.Proxy
    }
    exchanger := oauth2.NewDefaultExchangerWithProxy(config, proxyAddr)

    ctx := context.Background()
    token, err := exchanger.Exchange(ctx, req.Code, req.State)
    if err != nil {
        common.APIRespondWithError(c, http.StatusOK, fmt.Errorf("token exchange failed: %w", err))
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "success": true,
        "message": "OAuth2 authorization successful",
        "data": gin.H{
            "refresh_token": token.RefreshToken,
            "access_token":  token.AccessToken,
            "expires_in":    int(token.Expiry.Sub(common.GetTimeNow()).Seconds()),
        },
    })
}
```

```go
// TestOAuth2Token æµ‹è¯• OAuth2 Token æ˜¯å¦æœ‰æ•ˆ
func TestOAuth2Token(c *gin.Context) {
    var req struct {
        Provider     string  `json:"provider" binding:"required"`
        RefreshToken string  `json:"refresh_token" binding:"required"`
        Proxy        *string `json:"proxy"` // âœ… æ–°å¢ï¼šå¯é€‰çš„ä»£ç†åœ°å€
    }

    if err := c.ShouldBindJSON(&req); err != nil {
        common.APIRespondWithError(c, http.StatusBadRequest, err)
        return
    }

    // âœ… ä½¿ç”¨å¸¦ä»£ç†çš„æ„é€ å‡½æ•°
    proxyAddr := ""
    if req.Proxy != nil {
        proxyAddr = *req.Proxy
    }
    manager, err := oauth2.NewManagerWithProxy(req.Provider, req.RefreshToken, proxyAddr)
    if err != nil {
        common.APIRespondWithError(c, http.StatusOK, err)
        return
    }

    ctx := context.Background()
    token, err := manager.GetAccessToken(ctx)
    if err != nil {
        common.APIRespondWithError(c, http.StatusOK, fmt.Errorf("token validation failed: %w", err))
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "success": true,
        "message": "OAuth2 token is valid",
        "data": gin.H{
            "valid":      true,
            "expires_in": int(token.Expiry.Sub(common.GetTimeNow()).Seconds()),
        },
    })
}
```

#### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```javascript
// äº¤æ¢æˆæƒç ï¼ˆå¸¦ä»£ç†ï¼‰
const response = await fetch('/api/oauth2/exchange', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    provider: 'claude',
    code: 'abc123#xyz789',
    state: 'verifier_string',
    proxy: 'http://127.0.0.1:7890'  // âœ… ä¼ é€’ä»£ç†åœ°å€
  })
});

// æµ‹è¯• Tokenï¼ˆå¸¦ä»£ç†ï¼‰
const testResponse = await fetch('/api/oauth2/test', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    provider: 'claude',
    refresh_token: 'rt_xxxxx',
    proxy: 'socks5://127.0.0.1:7891'  // âœ… æ”¯æŒ SOCKS5
  })
});
```

---

### æ–¹æ¡ˆ 2: ä»ç¯å¢ƒå˜é‡è¯»å–ä»£ç†ï¼ˆå¤‡é€‰ï¼‰

å¦‚æœä¸æƒ³åœ¨æ¥å£ä¸­æ·»åŠ ä»£ç†å‚æ•°ï¼Œå¯ä»¥ä»ç¯å¢ƒå˜é‡è¯»å–ï¼š

```go
// åœ¨ controller/oauth2.go å¼€å¤´æ·»åŠ è¾…åŠ©å‡½æ•°
func getProxyFromEnv() string {
    // å°è¯•å¤šä¸ªç¯å¢ƒå˜é‡
    proxy := os.Getenv("OAUTH2_PROXY")
    if proxy == "" {
        proxy = os.Getenv("HTTPS_PROXY")
    }
    if proxy == "" {
        proxy = os.Getenv("HTTP_PROXY")
    }
    return proxy
}

// åœ¨ ExchangeOAuth2Code ä¸­ä½¿ç”¨
exchanger := oauth2.NewDefaultExchangerWithProxy(config, getProxyFromEnv())

// åœ¨ TestOAuth2Token ä¸­ä½¿ç”¨
manager, err := oauth2.NewManagerWithProxy(req.Provider, req.RefreshToken, getProxyFromEnv())
```

**ç¼ºç‚¹**ï¼š
- ä¸å¤Ÿçµæ´»ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨åŒä¸€ä¸ªä»£ç†
- æ— æ³•åœ¨ Web UI ä¸­é…ç½®

---

### æ–¹æ¡ˆ 3: æ··åˆæ–¹æ¡ˆï¼ˆæœ€çµæ´»ï¼‰

```go
func getProxyAddr(requestProxy *string) string {
    // ä¼˜å…ˆä½¿ç”¨è¯·æ±‚ä¸­çš„ä»£ç†
    if requestProxy != nil && *requestProxy != "" {
        return *requestProxy
    }

    // å…¶æ¬¡ä½¿ç”¨ç¯å¢ƒå˜é‡
    return getProxyFromEnv()
}
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: ç›´è¿ç¯å¢ƒ

```bash
# äº¤æ¢æˆæƒç ï¼ˆæ— ä»£ç†ï¼‰
curl -X POST http://localhost:3000/api/oauth2/exchange \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "claude",
    "code": "abc123#xyz789",
    "state": "verifier_string"
  }'

# âœ… é¢„æœŸï¼šæˆåŠŸï¼ˆç›´æ¥è¿æ¥ console.anthropic.comï¼‰
```

### æµ‹è¯•åœºæ™¯ 2: ä»£ç†ç¯å¢ƒï¼ˆHTTPï¼‰

```bash
# äº¤æ¢æˆæƒç ï¼ˆä½¿ç”¨ HTTP ä»£ç†ï¼‰
curl -X POST http://localhost:3000/api/oauth2/exchange \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "claude",
    "code": "abc123#xyz789",
    "state": "verifier_string",
    "proxy": "http://127.0.0.1:7890"
  }'

# âœ… é¢„æœŸï¼šæˆåŠŸï¼ˆé€šè¿‡ä»£ç†è¿æ¥ï¼‰
```

### æµ‹è¯•åœºæ™¯ 3: ä»£ç†ç¯å¢ƒï¼ˆSOCKS5ï¼‰

```bash
# æµ‹è¯• Tokenï¼ˆä½¿ç”¨ SOCKS5 ä»£ç†ï¼‰
curl -X POST http://localhost:3000/api/oauth2/test \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "claude",
    "refresh_token": "rt_xxxxx",
    "proxy": "socks5://127.0.0.1:7891"
  }'

# âœ… é¢„æœŸï¼šæˆåŠŸï¼ˆé€šè¿‡ SOCKS5 ä»£ç†è¿æ¥ï¼‰
```

### æµ‹è¯•åœºæ™¯ 4: éªŒè¯ä»£ç†é…ç½®é”™è¯¯å¤„ç†

```bash
# ä½¿ç”¨æ— æ•ˆçš„ä»£ç†åœ°å€
curl -X POST http://localhost:3000/api/oauth2/test \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "claude",
    "refresh_token": "rt_xxxxx",
    "proxy": "invalid://proxy"
  }'

# âœ… é¢„æœŸï¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼ˆunsupported proxy schemeï¼‰
```

---

## æ€»ç»“

### é—®é¢˜æ ¹å› 

1. **OAuth2 æµ‹è¯•å’Œäº¤æ¢æ¥å£ç¼ºå°‘ä»£ç†å‚æ•°**
2. **ä½¿ç”¨äº†ä¸æ”¯æŒä»£ç†çš„æ„é€ å‡½æ•°**
3. **æ²¡æœ‰å°†ä»£ç†åœ°å€ä¼ é€’ç»™åº•å±‚çš„ HTTP Client**

### ä¿®å¤è¦ç‚¹

1. âœ… åœ¨æ¥å£è¯·æ±‚ç»“æ„ä¸­æ·»åŠ  `Proxy *string` å­—æ®µ
2. âœ… ä½¿ç”¨ `NewDefaultExchangerWithProxy()` è€Œé `NewDefaultExchanger()`
3. âœ… ä½¿ç”¨ `NewManagerWithProxy()` è€Œé `NewManager()`
4. âœ… å‰ç«¯éœ€è¦åœ¨è¯·æ±‚ä¸­ä¼ é€’ä»£ç†åœ°å€

### å½±å“èŒƒå›´

- **æ–‡ä»¶**: `controller/oauth2.go`
- **æ¥å£**: `ExchangeOAuth2Code` å’Œ `TestOAuth2Token`
- **è¡Œæ•°**: çº¦ 10 è¡Œä¿®æ”¹

### ä¼˜å…ˆçº§

ğŸ”´ **é«˜ä¼˜å…ˆçº§** - è¿™æ˜¯é˜»æ­¢ OAuth2 åœ¨å—é™ç½‘ç»œç¯å¢ƒä¸‹å·¥ä½œçš„å…³é”®é—®é¢˜

---

## é™„å½•ï¼šä»£ç†é…ç½®ç¤ºä¾‹

### HTTP ä»£ç†

```
http://127.0.0.1:7890
http://proxy.example.com:8080
http://username:password@proxy.example.com:8080
```

### HTTPS ä»£ç†

```
https://127.0.0.1:7890
https://proxy.example.com:8443
```

### SOCKS5 ä»£ç†

```
socks5://127.0.0.1:7891
socks5://username:password@proxy.example.com:1080
```

### ä»£ç†è‡ªåŠ¨æ£€æµ‹é€»è¾‘

- ä»¥ `socks5://` å¼€å¤´ â†’ ä½¿ç”¨ SOCKS5 ä»£ç†
- ä»¥ `http://` æˆ– `https://` å¼€å¤´ â†’ ä½¿ç”¨ HTTP ä»£ç†
- æ”¯æŒç”¨æˆ·åå¯†ç è®¤è¯ï¼ˆURL ç¼–ç æ ¼å¼ï¼‰

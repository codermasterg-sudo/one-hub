# OAuth2 é…ç½®ç»´æŠ¤æŒ‡å—

## ğŸ“ Claude OAuth2 é…ç½®ä½ç½®

### æ–‡ä»¶ä½ç½®

```
providers/claude/oauth2_config.go
```

### é…ç½®æ–¹å¼

**âœ… å½“å‰æ–¹å¼ï¼šå¸¸é‡ï¼ˆç¡¬ç¼–ç ï¼‰**

```go
package claude

import (
	"one-api/common/oauth2"
	oauth2Lib "golang.org/x/oauth2"
)

func init() {
	// æ³¨å†Œ Claude çš„ OAuth2 é…ç½®
	oauth2.MustRegister(&oauth2.OAuth2Config{
		ProviderName: "claude",

		// === æ ¸å¿ƒ OAuth2 é…ç½®ï¼ˆå¸¸é‡ï¼‰===
		ClientID:     "9d1c250a-e61b-44d9-88ed-5944d1962f5e",  // Anthropic OAuth2 åº”ç”¨ ID
		ClientSecret: "",                                       // å…¬å¼€å®¢æˆ·ç«¯ï¼Œæ— éœ€ secret
		RedirectURL:  "https://console.anthropic.com/oauth/code/callback",

		// === OAuth2 ç«¯ç‚¹ï¼ˆå¸¸é‡ï¼‰===
		Endpoint: oauth2Lib.Endpoint{
			AuthURL:   "https://claude.ai/oauth/authorize",
			TokenURL:  "https://console.anthropic.com/v1/oauth/token",
			AuthStyle: oauth2Lib.AuthStyleInParams,
		},

		// === æƒé™èŒƒå›´ï¼ˆå¸¸é‡ï¼‰===
		Scopes: []string{
			"org:create_api_key",  // åˆ›å»º API Key æƒé™
			"user:profile",        // ç”¨æˆ·èµ„æ–™æƒé™
			"user:inference",      // æ¨ç†æƒé™
		},

		// === Claude ç‰¹æ®Šé…ç½®ï¼ˆå¸¸é‡ï¼‰===
		UsePKCE:          true,                     // ä½¿ç”¨ PKCE å®‰å…¨å¢å¼º
		TokenRequestType: oauth2.TokenRequestJSON, // JSON æ ¼å¼ï¼ˆéæ ‡å‡†ï¼‰
		AuthHeaderFormat: oauth2.AuthHeaderBearer, // Bearer Token æ ¼å¼
		CodeFormat:       "code#state",             // æˆæƒç æ ¼å¼

		// === å‰ç«¯æ˜¾ç¤ºé…ç½®ï¼ˆå¸¸é‡ï¼‰===
		DisplayName: "Claude (OAuth2)",
		HelpText:    "ä½¿ç”¨ Claude Pro æˆ– Claude Max è®¢é˜…è´¦å·æˆæƒ",
		IconURL:     "",
	})
}
```

---

## ğŸ“ é…ç½®è¯´æ˜

### æ ¸å¿ƒé…ç½®é¡¹

| é…ç½®é¡¹ | å½“å‰å€¼ | è¯´æ˜ | å¯èƒ½å˜åŒ– |
|-------|--------|------|---------|
| **ClientID** | `9d1c250a-e61b-44d9-88ed-5944d1962f5e` | Anthropic OAuth2 åº”ç”¨ ID | âš ï¸ å¯èƒ½ï¼ˆåº”ç”¨æ›´æ–°ï¼‰ |
| **AuthURL** | `https://claude.ai/oauth/authorize` | æˆæƒç«¯ç‚¹ | âŒ ä¸å¤ªå¯èƒ½ |
| **TokenURL** | `https://console.anthropic.com/v1/oauth/token` | Token ç«¯ç‚¹ | âŒ ä¸å¤ªå¯èƒ½ |
| **RedirectURL** | `https://console.anthropic.com/oauth/code/callback` | å›è°ƒåœ°å€ | âŒ ä¸å¤ªå¯èƒ½ |
| **Scopes** | `org:create_api_key`, `user:profile`, `user:inference` | æƒé™èŒƒå›´ | âš ï¸ å¯èƒ½ï¼ˆåŠŸèƒ½å¢åŠ ï¼‰ |

### ç‰¹æ®Šé…ç½®é¡¹

| é…ç½®é¡¹ | å½“å‰å€¼ | è¯´æ˜ |
|-------|--------|------|
| **UsePKCE** | `true` | ä½¿ç”¨ PKCEï¼ˆProof Key for Code Exchangeï¼‰å®‰å…¨å¢å¼º |
| **TokenRequestType** | `TokenRequestJSON` | Claude ä½¿ç”¨ JSON æ ¼å¼ï¼ˆé OAuth2 æ ‡å‡†çš„ Form æ ¼å¼ï¼‰ |
| **AuthHeaderFormat** | `AuthHeaderBearer` | ä½¿ç”¨ `Authorization: Bearer xxx` æ ¼å¼ |
| **CodeFormat** | `"code#state"` | Claude è¿”å›æˆæƒç æ ¼å¼ä¸º `code#state`ï¼ˆéæ ‡å‡†ï¼‰ |

---

## ğŸ”§ å¦‚ä½•ä¿®æ”¹é…ç½®

### æ–¹å¼ 1: ç›´æ¥ä¿®æ”¹ä»£ç ï¼ˆå½“å‰æ–¹å¼ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- Anthropic æ›´æ–°äº† OAuth2 åº”ç”¨é…ç½®
- ClientID æˆ–ç«¯ç‚¹å˜åŒ–
- éœ€è¦æ·»åŠ æ–°çš„æƒé™èŒƒå›´

**æ“ä½œæ­¥éª¤ï¼š**

1. **ç¼–è¾‘é…ç½®æ–‡ä»¶**
```bash
vim providers/claude/oauth2_config.go
```

2. **ä¿®æ”¹é…ç½®å€¼**
```go
// ä¾‹å¦‚ï¼šAnthropic æ›´æ–°äº† ClientID
ClientID: "new-client-id-from-anthropic",

// ä¾‹å¦‚ï¼šæ·»åŠ æ–°çš„æƒé™èŒƒå›´
Scopes: []string{
    "org:create_api_key",
    "user:profile",
    "user:inference",
    "new:scope",  // æ–°å¢
},
```

3. **é‡æ–°ç¼–è¯‘éƒ¨ç½²**
```bash
make one-api
# æˆ–
docker-compose build
docker-compose up -d
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç®€å•ç›´æ¥
- âœ… ç±»å‹å®‰å…¨
- âœ… IDE æ”¯æŒä»£ç è¡¥å…¨

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦é‡æ–°ç¼–è¯‘
- âŒ éœ€è¦é‡å¯æœåŠ¡
- âŒ é…ç½®å˜æ›´éœ€è¦ä»£ç æäº¤

---

### æ–¹å¼ 2: ç¯å¢ƒå˜é‡è¦†ç›–ï¼ˆæ¨èæ”¹è¿›ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- ä¼ä¸šç‰ˆéƒ¨ç½²ï¼ˆä¸åŒ ClientIDï¼‰
- è‡ªæ‰˜ç®¡åœºæ™¯ï¼ˆä¸åŒç«¯ç‚¹ï¼‰
- æµ‹è¯•ç¯å¢ƒï¼ˆä½¿ç”¨æµ‹è¯•åº”ç”¨ï¼‰

**å®ç°æ–¹å¼ï¼š**

1. **ä¿®æ”¹ `providers/claude/oauth2_config.go`**
```go
func init() {
    // ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæä¾›é»˜è®¤å€¼
    clientID := os.Getenv("CLAUDE_OAUTH2_CLIENT_ID")
    if clientID == "" {
        clientID = "9d1c250a-e61b-44d9-88ed-5944d1962f5e" // é»˜è®¤å€¼
    }

    authURL := os.Getenv("CLAUDE_OAUTH2_AUTH_URL")
    if authURL == "" {
        authURL = "https://claude.ai/oauth/authorize" // é»˜è®¤å€¼
    }

    tokenURL := os.Getenv("CLAUDE_OAUTH2_TOKEN_URL")
    if tokenURL == "" {
        tokenURL = "https://console.anthropic.com/v1/oauth/token" // é»˜è®¤å€¼
    }

    oauth2.MustRegister(&oauth2.OAuth2Config{
        ProviderName: "claude",
        ClientID:     clientID,      // ä½¿ç”¨å˜é‡
        Endpoint: oauth2Lib.Endpoint{
            AuthURL:  authURL,       // ä½¿ç”¨å˜é‡
            TokenURL: tokenURL,      // ä½¿ç”¨å˜é‡
        },
        // ... å…¶ä»–é…ç½®
    })
}
```

2. **éƒ¨ç½²æ—¶é…ç½®ç¯å¢ƒå˜é‡**
```yaml
# docker-compose.yml
environment:
  # å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤å€¼
  - CLAUDE_OAUTH2_CLIENT_ID=custom-client-id
  - CLAUDE_OAUTH2_AUTH_URL=https://custom.claude.ai/oauth/authorize
  - CLAUDE_OAUTH2_TOKEN_URL=https://custom.claude.ai/v1/oauth/token
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ— éœ€ä¿®æ”¹ä»£ç 
- âœ… æ— éœ€é‡æ–°ç¼–è¯‘
- âœ… æ”¯æŒä¸åŒç¯å¢ƒï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- âœ… å‘åå…¼å®¹ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤å€¼ï¼‰

**ç¼ºç‚¹ï¼š**
- âš ï¸ æ‰€æœ‰ Claude OAuth2 æ¸ é“å…±äº«é…ç½®
- âš ï¸ éœ€è¦ä¿®æ”¹éƒ¨ç½²é…ç½®

**çŠ¶æ€ï¼š** æœªå®ç°ï¼ˆè¯¦è§ `é…ç½®çµæ´»æ€§åˆ†æ.md`ï¼‰

---

### æ–¹å¼ 3: æ•°æ®åº“é…ç½®ï¼ˆæœªæ¥è€ƒè™‘ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- å¤šç§Ÿæˆ·éœ€æ±‚
- ä¸åŒæ¸ é“ä½¿ç”¨ä¸åŒ OAuth2 åº”ç”¨
- éœ€è¦åœ¨é¡µé¢ä¸Šé…ç½®

**å®ç°æ–¹å¼ï¼š**
- åœ¨ `channels` è¡¨æ–°å¢ `oauth2_config` å­—æ®µï¼ˆJSON ç±»å‹ï¼‰
- æ¸ é“åˆ›å»ºæ—¶å¯é€‰å¡«å†™è‡ªå®šä¹‰é…ç½®
- Provider åˆå§‹åŒ–æ—¶åˆå¹¶é…ç½®

**çŠ¶æ€ï¼š** æœªå®ç°ï¼ˆè¯¦è§ `é…ç½®çµæ´»æ€§åˆ†æ.md` æ–¹æ¡ˆ 3ï¼‰

---

## ğŸ“š é…ç½®ä¿®æ”¹åœºæ™¯

### åœºæ™¯ 1: Anthropic æ›´æ–° ClientID

**è§¦å‘æ¡ä»¶ï¼š**
- Anthropic å®£å¸ƒå¼ƒç”¨æ—§ ClientID
- å‘å¸ƒæ–°çš„ OAuth2 åº”ç”¨

**æ“ä½œæ­¥éª¤ï¼š**

**å½“å‰æ–¹å¼ï¼ˆæ–¹å¼ 1ï¼‰ï¼š**
```bash
# 1. ä¿®æ”¹é…ç½®
vim providers/claude/oauth2_config.go
# å°† ClientID æ”¹ä¸ºæ–°å€¼

# 2. æäº¤ä»£ç 
git add providers/claude/oauth2_config.go
git commit -m "feat: æ›´æ–° Claude OAuth2 ClientID"

# 3. é‡æ–°éƒ¨ç½²
make one-api
# æˆ–
docker-compose build && docker-compose up -d
```

**å¦‚æœå®æ–½æ–¹å¼ 2ï¼ˆç¯å¢ƒå˜é‡ï¼‰ï¼š**
```bash
# 1. æ›´æ–°ç¯å¢ƒå˜é‡
vim docker-compose.yml
# æ·»åŠ  CLAUDE_OAUTH2_CLIENT_ID=new-client-id

# 2. é‡å¯æœåŠ¡
docker-compose up -d
```

---

### åœºæ™¯ 2: æ·»åŠ æ–°çš„ Scopes

**è§¦å‘æ¡ä»¶ï¼š**
- Anthropic æ–°å¢æƒé™èŒƒå›´
- éœ€è¦æ–°åŠŸèƒ½ï¼ˆå¦‚ Fine-tuningï¼‰

**æ“ä½œæ­¥éª¤ï¼š**
```go
// providers/claude/oauth2_config.go
Scopes: []string{
    "org:create_api_key",
    "user:profile",
    "user:inference",
    "model:finetune",  // æ–°å¢
},
```

---

### åœºæ™¯ 3: ä¼ä¸šç‰ˆéƒ¨ç½²

**è§¦å‘æ¡ä»¶ï¼š**
- ä½¿ç”¨ä¼ä¸šç‰ˆ Claude
- ç‹¬ç«‹çš„ OAuth2 åº”ç”¨
- ä¸åŒçš„ç«¯ç‚¹

**æ¨èæ–¹å¼ï¼š** å®æ–½æ–¹å¼ 2ï¼ˆç¯å¢ƒå˜é‡ï¼‰

```yaml
# docker-compose.yml (ä¼ä¸šç‰ˆé…ç½®)
environment:
  - CLAUDE_OAUTH2_CLIENT_ID=enterprise-client-id
  - CLAUDE_OAUTH2_AUTH_URL=https://enterprise.claude.ai/oauth/authorize
  - CLAUDE_OAUTH2_TOKEN_URL=https://enterprise.claude.ai/v1/oauth/token
```

---

## âš™ï¸ é…ç½®éªŒè¯

### éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

**æ–¹æ³• 1: æ£€æŸ¥æ—¥å¿—**
```bash
docker-compose logs one-hub | grep -i oauth2

# é¢„æœŸè¾“å‡ºï¼š
# INFO: OAuth2 config registered: claude
# INFO: ClientID: 9d1c250a-... (æˆ–æ–°å€¼)
```

**æ–¹æ³• 2: è°ƒç”¨ API**
```bash
curl http://localhost:3000/api/oauth2/providers

# æ£€æŸ¥è¿”å›çš„é…ç½®
{
  "success": true,
  "data": {
    "claude": {
      "display_name": "Claude (OAuth2)",
      "help_text": "ä½¿ç”¨ Claude Pro æˆ– Claude Max è®¢é˜…è´¦å·æˆæƒ",
      "code_format": "code#state"
    }
  }
}
```

**æ–¹æ³• 3: æµ‹è¯•æˆæƒæµç¨‹**
```bash
# 1. è·å–æˆæƒ URL
curl 'http://localhost:3000/api/oauth2/auth_url?provider=claude'

# 2. æ£€æŸ¥è¿”å›çš„ auth_url æ˜¯å¦åŒ…å«æ­£ç¡®çš„ ClientID
{
  "auth_url": "https://claude.ai/oauth/authorize?client_id=9d1c250a-...",
  ...
}
```

---

## ğŸ”’ é…ç½®å®‰å…¨

### æ•æ„Ÿé…ç½®ä¿æŠ¤

| é…ç½®é¡¹ | æ•æ„Ÿæ€§ | ä¿æŠ¤å»ºè®® |
|-------|--------|---------|
| **ClientID** | âš ï¸ ä¸­ç­‰ | å…¬å¼€å®¢æˆ·ç«¯ï¼Œå¯è§ä½†ä¸åº”æ³„éœ² |
| **ClientSecret** | ğŸ”´ é«˜ | Claude ä¸ºå…¬å¼€å®¢æˆ·ç«¯ï¼Œæ—  Secret |
| **RefreshToken** | ğŸ”´ æé«˜ | å­˜å‚¨åœ¨æ•°æ®åº“åŠ å¯†å­—æ®µ |
| **AccessToken** | ğŸ”´ é«˜ | ä»…å†…å­˜ç¼“å­˜ï¼Œä¸æŒä¹…åŒ– |

### é…ç½®å˜æ›´å®¡è®¡

**æ¨èåšæ³•ï¼š**
1. âœ… é…ç½®å˜æ›´éœ€è¦ Code Review
2. âœ… è®°å½•å˜æ›´åŸå› å’Œæ¥æº
3. âœ… æµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½²ç”Ÿäº§
4. âœ… ä¿ç•™æ—§é…ç½®å¤‡ä»½ï¼ˆå›æ»šç”¨ï¼‰

---

## ğŸ“Š é…ç½®å¯¹æ¯”

| é…ç½®æ–¹å¼ | çµæ´»æ€§ | å¤æ‚åº¦ | å®‰å…¨æ€§ | æ¨èåœºæ™¯ |
|---------|--------|--------|--------|---------|
| **æ–¹å¼ 1ï¼šä»£ç å¸¸é‡** | â­ | â­ | â­â­â­ | å•ä¸€ç¯å¢ƒï¼Œå®˜æ–¹é…ç½® |
| **æ–¹å¼ 2ï¼šç¯å¢ƒå˜é‡** | â­â­â­ | â­â­ | â­â­â­ | å¤šç¯å¢ƒï¼Œä¼ä¸šç‰ˆ |
| **æ–¹å¼ 3ï¼šæ•°æ®åº“é…ç½®** | â­â­â­â­â­ | â­â­â­â­ | â­â­ | å¤šç§Ÿæˆ·ï¼Œæ¸ é“çº§é…ç½® |

---

## ğŸš€ å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨é…ç½®ä¿®æ”¹

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶
vim providers/claude/oauth2_config.go

# é‡æ–°ç¼–è¯‘
make one-api

# Docker éƒ¨ç½²
docker-compose build
docker-compose up -d

# éªŒè¯é…ç½®
curl http://localhost:3000/api/oauth2/providers
```

### é…ç½®æ–‡ä»¶ä½ç½®é€ŸæŸ¥

```
providers/claude/oauth2_config.go    # Claude OAuth2 é…ç½®
common/oauth2/types.go               # é…ç½®ç±»å‹å®šä¹‰
common/oauth2/registry.go            # é…ç½®æ³¨å†Œè¡¨
controller/oauth2.go                 # OAuth2 API
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é…ç½®çµæ´»æ€§åˆ†æ.md](./é…ç½®çµæ´»æ€§åˆ†æ.md) - é…ç½®çµæ´»åŒ–æ–¹æ¡ˆ
- [æ¶æ„è§£è€¦åˆ†æ.md](./æ¶æ„è§£è€¦åˆ†æ.md) - æ¡†æ¶ä¸é…ç½®è§£è€¦
- [OAuth2å®ç°æ–‡æ¡£.md](./OAuth2å®ç°æ–‡æ¡£.md) - æŠ€æœ¯å®ç°ç»†èŠ‚

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-11-20
**ç»´æŠ¤è€…ï¼š** One Hub Team

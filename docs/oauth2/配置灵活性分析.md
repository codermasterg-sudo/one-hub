# OAuth2 é…ç½®çµæ´»æ€§åˆ†æ

## é—®é¢˜èƒŒæ™¯

OAuth2 é…ç½®ï¼ˆClientIDã€AuthURLã€TokenURL ç­‰ï¼‰ç›®å‰å›ºåŒ–åœ¨ä»£ç ä¸­ï¼Œæ˜¯å¦åº”è¯¥æ”¯æŒè‡ªå®šä¹‰é…ç½®ï¼Ÿ

## ğŸ” å½“å‰å®ç°åˆ†æ

### OAuth2 å›ºåŒ–é…ç½®

```go
// providers/claude/oauth2_config.go
func init() {
    oauth2.MustRegister(&oauth2.OAuth2Config{
        ProviderName:     "claude",
        ClientID:         "9d1c250a-e61b-44d9-88ed-5944d1962f5e",  // å›ºåŒ–
        AuthURL:          "https://claude.ai/oauth/authorize",      // å›ºåŒ–
        TokenURL:         "https://console.anthropic.com/v1/oauth/token", // å›ºåŒ–
        // ... å…¶ä»–é…ç½®
    })
}
```

### å…¶ä»– Channel çš„å¤„ç†æ–¹å¼

#### 1. BaseURL çš„å¤„ç†æ¨¡å¼ï¼ˆæ¨èï¼‰

**ä»£ç é»˜è®¤å€¼ + æ•°æ®åº“è¦†ç›–æœºåˆ¶ï¼š**

```go
// providers/claude/base.go
func getConfig() base.ProviderConfig {
    return base.ProviderConfig{
        BaseURL: "https://api.anthropic.com",  // ä»£ç ä¸­çš„é»˜è®¤å€¼
    }
}

// providers/base/common.go
func (p *BaseProvider) GetBaseURL() string {
    if p.Channel.GetBaseURL() != "" {
        return p.Channel.GetBaseURL()  // âœ… ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“é…ç½®
    }
    return p.Config.BaseURL  // é»˜è®¤å€¼
}
```

**æ•°æ®åº“å­—æ®µï¼š**
```sql
CREATE TABLE channels (
    id INT PRIMARY KEY,
    type INT,
    base_url VARCHAR(255),  -- å¯é€‰ï¼Œå…è®¸è¦†ç›–é»˜è®¤ BaseURL
    -- ...
);
```

**ç”¨æˆ·é…ç½®æ–¹å¼ï¼š**
- æ¸ é“ç®¡ç†é¡µé¢ â†’ ç¼–è¾‘æ¸ é“ â†’ Base URL å­—æ®µ
- ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼
- å¡«å†™åˆ™è¦†ç›–é»˜è®¤å€¼

---

#### 2. ä» Key å­—æ®µè§£æï¼ˆç™¾åº¦ç­‰ï¼‰

```go
// providers/baidu/base.go
// Channel.Key æ ¼å¼: "client_id:client_secret"
parts := strings.Split(p.Channel.Key, ":")
clientID := parts[0]      // ä» Key è§£æ
clientSecret := parts[1]  // ä» Key è§£æ

url := fmt.Sprintf("%s/oauth/2.0/token?client_id=%s&client_secret=%s",
                   p.Config.BaseURL, clientID, clientSecret)
```

**ç‰¹ç‚¹ï¼š**
- çµæ´»ï¼šç”¨æˆ·å¯ä»¥é…ç½®è‡ªå·±çš„ ClientID å’Œ ClientSecret
- ç®€å•ï¼šæ— éœ€æ–°å¢æ•°æ®åº“å­—æ®µ
- å±€é™ï¼šåªèƒ½é€šè¿‡ Key å­—æ®µä¼ é€’å‚æ•°

---

## ğŸ“Š Claude OAuth2 é…ç½®åˆ†æ

### é…ç½®é¡¹åˆ†ç±»

| é…ç½®é¡¹ | å½“å‰å€¼ | æ˜¯å¦å¯èƒ½å˜åŒ– | å»ºè®®å¤„ç†æ–¹å¼ |
|-------|--------|------------|------------|
| **ClientID** | `9d1c250a-...` | âš ï¸ å¯èƒ½ | è€ƒè™‘æ”¯æŒè‡ªå®šä¹‰ |
| **AuthURL** | `https://claude.ai/oauth/authorize` | âŒ ä¸å¤ªå¯èƒ½ | ä¿æŒå›ºåŒ– |
| **TokenURL** | `https://console.anthropic.com/v1/oauth/token` | âŒ ä¸å¤ªå¯èƒ½ | ä¿æŒå›ºåŒ– |
| **Scopes** | ç©º | âŒ ä¸å¤ªå¯èƒ½ | ä¿æŒå›ºåŒ– |
| **RedirectURL** | `urn:ietf:wg:oauth:2.0:oob` | âŒ ä¸å¤ªå¯èƒ½ | ä¿æŒå›ºåŒ– |

### å¯èƒ½éœ€è¦ä¿®æ”¹çš„åœºæ™¯

#### 1. ClientID å¯èƒ½å˜åŒ–çš„æƒ…å†µ

**åœºæ™¯ A: Anthropic æ›´æ–° OAuth2 åº”ç”¨**
- Anthropic å¯èƒ½å¼ƒç”¨æ—§çš„ ClientID
- å‘å¸ƒæ–°çš„ ClientID
- ç”¨æˆ·éœ€è¦å‡çº§ä»£ç æ‰èƒ½ç»§ç»­ä½¿ç”¨

**åœºæ™¯ B: ä¼ä¸šç‰ˆ Claude**
- ä¼ä¸šå®¢æˆ·å¯èƒ½æœ‰ç‹¬ç«‹çš„ OAuth2 åº”ç”¨
- ClientID ä¸åŒäºå…¬å¼€ç‰ˆæœ¬
- éœ€è¦æ”¯æŒè‡ªå®šä¹‰ ClientID

**åœºæ™¯ C: è‡ªæ‰˜ç®¡ Claudeï¼ˆæœªæ¥ï¼‰**
- å¦‚æœæœ‰è‡ªæ‰˜ç®¡ç‰ˆæœ¬
- AuthURL å’Œ TokenURL éƒ½ä¼šä¸åŒ
- éœ€è¦å®Œå…¨è‡ªå®šä¹‰ç«¯ç‚¹

---

## ğŸ¯ æ”¹è¿›æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¿æŒç°çŠ¶ï¼ˆæ¨èçŸ­æœŸï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… ç®€å•ï¼Œæ— éœ€ä¿®æ”¹
- âœ… å¯¹ 99% çš„ç”¨æˆ·è¶³å¤Ÿ
- âœ… é™ä½é…ç½®å¤æ‚åº¦

**ç¼ºç‚¹ï¼š**
- âŒ ClientID å˜åŒ–æ—¶éœ€è¦æ›´æ–°ä»£ç 
- âŒ ä¸æ”¯æŒä¼ä¸šç‰ˆæˆ–è‡ªæ‰˜ç®¡åœºæ™¯

**é€‚ç”¨åœºæ™¯ï¼š**
- Anthropic å®˜æ–¹ OAuth2 åº”ç”¨ç¨³å®š
- å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨å…¬å¼€ç‰ˆ Claude
- çŸ­æœŸå†…æ— ä¼ä¸šç‰ˆéœ€æ±‚

---

### æ–¹æ¡ˆ 2: æ”¯æŒ BaseURL è¦†ç›–ï¼ˆæ¨èä¸­æœŸï¼‰

**å®ç°æ–¹å¼ï¼š**

1. **ä½¿ç”¨ç°æœ‰çš„ Channel.BaseURL å­—æ®µ**

```go
// providers/claude/oauth2_config.go
func init() {
    oauth2.MustRegister(&oauth2.OAuth2Config{
        ProviderName:     "claude",
        ClientID:         "9d1c250a-e61b-44d9-88ed-5944d1962f5e",
        // AuthURL å’Œ TokenURL åŸºäº BaseURL åŠ¨æ€ç”Ÿæˆ
        // æˆ–è€…æ–°å¢å­—æ®µæ”¯æŒå®Œæ•´ URL è¦†ç›–
    })
}

// providers/claude/oauth2_provider.go
func (f ClaudeOAuth2ProviderFactory) Create(channel *model.Channel) base.ProviderInterface {
    config, _ := oauth2.GetConfig("claude")

    // å¦‚æœç”¨æˆ·è®¾ç½®äº† BaseURLï¼Œè¦†ç›–ç«¯ç‚¹
    if channel.GetBaseURL() != "" {
        baseURL := channel.GetBaseURL()
        config.AuthURL = baseURL + "/oauth/authorize"
        config.TokenURL = baseURL + "/v1/oauth/token"
    }

    // ...
}
```

2. **å‰ç«¯é…ç½®**

```jsx
// web/src/views/Channel/type/Config.js
57: {
    inputLabel: {
        key: 'OAuth2 Refresh Token',
        base_url: 'OAuth2 Base URLï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰'
    },
    // ...
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… å¤ç”¨ç°æœ‰å­—æ®µï¼Œæ— éœ€æ•°æ®åº“æ”¹åŠ¨
- âœ… æ”¯æŒè‡ªæ‰˜ç®¡åœºæ™¯
- âœ… ä¿æŒç®€å•ï¼Œå¤§å¤šæ•°ç”¨æˆ·ç•™ç©ºå³å¯

**ç¼ºç‚¹ï¼š**
- âš ï¸ ä»ç„¶ä¸æ”¯æŒè‡ªå®šä¹‰ ClientID
- âš ï¸ éœ€è¦ç”¨æˆ·äº†è§£å®Œæ•´çš„ OAuth2 ç«¯ç‚¹ç»“æ„

---

### æ–¹æ¡ˆ 3: å®Œå…¨å¯é…ç½®ï¼ˆé•¿æœŸè€ƒè™‘ï¼‰

**å®ç°æ–¹å¼ï¼š**

1. **æ–°å¢æ•°æ®åº“å­—æ®µï¼ˆå¯é€‰ï¼Œä½¿ç”¨ JSONï¼‰**

```go
// model/channel.go
type Channel struct {
    // ... ç°æœ‰å­—æ®µ
    OAuth2Config *datatypes.JSONType[OAuth2ChannelConfig] `json:"oauth2_config" gorm:"type:json"`
}

type OAuth2ChannelConfig struct {
    ClientID    string `json:"client_id,omitempty"`
    AuthURL     string `json:"auth_url,omitempty"`
    TokenURL    string `json:"token_url,omitempty"`
    RedirectURL string `json:"redirect_url,omitempty"`
}
```

2. **Provider åˆå§‹åŒ–æ—¶åˆå¹¶é…ç½®**

```go
func (f ClaudeOAuth2ProviderFactory) Create(channel *model.Channel) base.ProviderInterface {
    // è·å–é»˜è®¤é…ç½®
    config, _ := oauth2.GetConfig("claude")

    // å¦‚æœæœ‰è‡ªå®šä¹‰é…ç½®ï¼Œè¦†ç›–é»˜è®¤å€¼
    if channel.OAuth2Config != nil {
        if channel.OAuth2Config.ClientID != "" {
            config.ClientID = channel.OAuth2Config.ClientID
        }
        if channel.OAuth2Config.AuthURL != "" {
            config.AuthURL = channel.OAuth2Config.AuthURL
        }
        // ...
    }

    // ...
}
```

3. **å‰ç«¯é«˜çº§é…ç½®**

```jsx
// OAuth2 é«˜çº§é…ç½®ï¼ˆæŠ˜å é¢æ¿ï¼‰
<Accordion>
  <AccordionSummary>é«˜çº§ OAuth2 é…ç½®</AccordionSummary>
  <AccordionDetails>
    <TextField label="Client IDï¼ˆå¯é€‰ï¼‰" />
    <TextField label="Auth URLï¼ˆå¯é€‰ï¼‰" />
    <TextField label="Token URLï¼ˆå¯é€‰ï¼‰" />
  </AccordionDetails>
</Accordion>
```

**ä¼˜ç‚¹ï¼š**
- âœ… æœ€çµæ´»ï¼Œæ”¯æŒæ‰€æœ‰åœºæ™¯
- âœ… å‘åå…¼å®¹ï¼ˆå­—æ®µå¯é€‰ï¼‰
- âœ… æ”¯æŒä¼ä¸šç‰ˆã€è‡ªæ‰˜ç®¡ç­‰ç‰¹æ®Šéœ€æ±‚

**ç¼ºç‚¹ï¼š**
- âš ï¸ å¢åŠ å¤æ‚åº¦
- âš ï¸ éœ€è¦æ•°æ®åº“å­—æ®µï¼ˆè™½ç„¶æ˜¯ JSONï¼Œå½±å“è¾ƒå°ï¼‰
- âš ï¸ é…ç½®é”™è¯¯å¯èƒ½å¯¼è‡´æˆæƒå¤±è´¥

---

## ğŸš€ æ¨èå®æ–½è·¯çº¿

### é˜¶æ®µ 1: å½“å‰ï¼ˆv1.0ï¼‰

**ä¿æŒå›ºåŒ–é…ç½®**
- é€‚åˆç»å¤§å¤šæ•°ç”¨æˆ·
- ç®€å•å¯é 
- æ— éœ€ä¿®æ”¹

### é˜¶æ®µ 2: æœ‰éœ€æ±‚æ—¶ï¼ˆv1.1ï¼‰

**æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–ï¼ˆæœ€å°æ”¹åŠ¨ï¼‰**

```bash
# ç¯å¢ƒå˜é‡
CLAUDE_OAUTH2_CLIENT_ID=your-custom-client-id
CLAUDE_OAUTH2_AUTH_URL=https://custom.claude.ai/oauth/authorize
CLAUDE_OAUTH2_TOKEN_URL=https://custom.claude.ai/v1/oauth/token
```

```go
// providers/claude/oauth2_config.go
func init() {
    clientID := os.Getenv("CLAUDE_OAUTH2_CLIENT_ID")
    if clientID == "" {
        clientID = "9d1c250a-e61b-44d9-88ed-5944d1962f5e"  // é»˜è®¤å€¼
    }

    authURL := os.Getenv("CLAUDE_OAUTH2_AUTH_URL")
    if authURL == "" {
        authURL = "https://claude.ai/oauth/authorize"  // é»˜è®¤å€¼
    }

    oauth2.MustRegister(&oauth2.OAuth2Config{
        ClientID: clientID,
        AuthURL:  authURL,
        // ...
    })
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä»£ç æ”¹åŠ¨æœ€å°ï¼ˆä»…ä¿®æ”¹ oauth2_config.goï¼‰
- âœ… æ— éœ€æ•°æ®åº“æ”¹åŠ¨
- âœ… æ— éœ€å‰ç«¯æ”¹åŠ¨
- âœ… æ”¯æŒä¼ä¸šéƒ¨ç½²åœºæ™¯
- âœ… é»˜è®¤å€¼ä¿æŒä¸å˜ï¼Œå‘åå…¼å®¹

**ç¼ºç‚¹ï¼š**
- âš ï¸ ä¸æ”¯æŒå¤šæ¸ é“ä½¿ç”¨ä¸åŒé…ç½®ï¼ˆæ‰€æœ‰ Claude OAuth2 æ¸ é“å…±äº«åŒä¸€é…ç½®ï¼‰

### é˜¶æ®µ 3: æœ‰å¼ºéœ€æ±‚æ—¶ï¼ˆv2.0ï¼‰

**å®æ–½æ–¹æ¡ˆ 3ï¼ˆå®Œå…¨å¯é…ç½®ï¼‰**
- é€‚åˆæœ‰å¤šç§Ÿæˆ·ã€ä¼ä¸šç‰ˆç­‰å¤æ‚éœ€æ±‚çš„åœºæ™¯
- éœ€è¦å®Œæ•´çš„äº§å“è§„åˆ’å’Œæµ‹è¯•

---

## ğŸ’¡ å…¶ä»– Provider çš„å‚è€ƒå®ç°

### OpenAI

```go
// BaseURL å¯è¦†ç›–
func (p *OpenAIProvider) GetBaseURL() string {
    if p.Channel.GetBaseURL() != "" {
        return p.Channel.GetBaseURL()  // ç”¨æˆ·è‡ªå®šä¹‰
    }
    return "https://api.openai.com"  // é»˜è®¤å€¼
}
```

### Azure

```go
// BaseURL å®Œå…¨ç”±ç”¨æˆ·é…ç½®
func getConfig() base.ProviderConfig {
    return base.ProviderConfig{
        BaseURL: "",  // ç©ºï¼Œå¼ºåˆ¶ç”¨æˆ·é…ç½®
    }
}
```

### Baidu

```go
// ClientID å’Œ ClientSecret ä» Key è§£æ
parts := strings.Split(p.Channel.Key, ":")
clientID := parts[0]
clientSecret := parts[1]
```

---

## ğŸ“ ç»“è®º

### å½“å‰ OAuth2 å®ç°

**âœ… ç°çŠ¶è¯„ä¼°ï¼š**
- å›ºåŒ–é…ç½®é€‚åˆ Anthropic å®˜æ–¹ OAuth2
- 99% çš„ç”¨æˆ·æ— éœ€ä¿®æ”¹
- æ¶æ„è®¾è®¡è‰¯å¥½ï¼Œæ˜“äºæ‰©å±•

**âš ï¸ æ½œåœ¨é—®é¢˜ï¼š**
- ClientID å˜åŒ–æ—¶éœ€è¦æ›´æ–°ä»£ç 
- ä¸æ”¯æŒä¼ä¸šç‰ˆæˆ–è‡ªæ‰˜ç®¡åœºæ™¯
- å¤šæ¸ é“æ— æ³•ä½¿ç”¨ä¸åŒçš„ OAuth2 åº”ç”¨

### å»ºè®®

**çŸ­æœŸï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š**
- âœ… ä¿æŒå½“å‰è®¾è®¡
- âœ… ç›‘æ§ Anthropic OAuth2 å˜åŒ–
- âœ… æ”¶é›†ç”¨æˆ·åé¦ˆ

**ä¸­æœŸï¼ˆ6-12ä¸ªæœˆï¼Œå¦‚æœ‰éœ€æ±‚ï¼‰ï¼š**
- âœ… å®æ–½æ–¹æ¡ˆ 2ï¼ˆç¯å¢ƒå˜é‡è¦†ç›–ï¼‰
- âœ… ä»£ç æ”¹åŠ¨æœ€å°
- âœ… æ»¡è¶³ä¼ä¸šéƒ¨ç½²éœ€æ±‚

**é•¿æœŸï¼ˆ12ä¸ªæœˆ+ï¼Œå¦‚æœ‰å¼ºéœ€æ±‚ï¼‰ï¼š**
- âœ… å®æ–½æ–¹æ¡ˆ 3ï¼ˆå®Œå…¨å¯é…ç½®ï¼‰
- âœ… æ”¯æŒå¤šç§Ÿæˆ·ç­‰å¤æ‚åœºæ™¯

---

## ğŸ”— ç›¸å…³ä»£ç ä½ç½®

| æ–‡ä»¶ | ä½œç”¨ | æ˜¯å¦éœ€è¦ä¿®æ”¹ |
|------|------|------------|
| `providers/claude/oauth2_config.go` | OAuth2 é…ç½®æ³¨å†Œ | æ–¹æ¡ˆ 2 éœ€è¦ |
| `common/oauth2/registry.go` | é…ç½®æ³¨å†Œè¡¨ | æ— éœ€ä¿®æ”¹ |
| `providers/claude/oauth2_provider.go` | Provider åˆ›å»º | æ–¹æ¡ˆ 3 éœ€è¦ |
| `model/channel.go` | Channel æ¨¡å‹ | æ–¹æ¡ˆ 3 éœ€è¦ |
| `web/src/views/Channel/type/Config.js` | å‰ç«¯é…ç½® | æ–¹æ¡ˆ 3 éœ€è¦ |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-11-20
**ç»´æŠ¤è€…ï¼š** One Hub Team

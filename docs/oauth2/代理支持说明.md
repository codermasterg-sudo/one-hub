# OAuth2 渠道代理支持说明

## 问题背景

在某些网络环境下，直接访问 Claude 的 OAuth2 服务（`https://console.anthropic.com`）可能无法连接。虽然 One Hub 的渠道配置支持代理设置，但在之前的实现中，**只有 API 请求使用了代理配置，OAuth2 的 token 交换和刷新操作没有使用代理**。

## 解决方案

本次更新为 Claude OAuth2 渠道添加了完整的代理支持，包括：

1. **授权码交换**：将授权码交换为 access_token 和 refresh_token
2. **Token 自动刷新**：在 access_token 过期时自动使用 refresh_token 刷新
3. **API 请求**：所有的 Claude API 调用（已有功能）

### 技术实现

#### 1. OAuth2 核心模块改进

**新增文件：**
- `common/oauth2/http_client.go`：提供带代理配置的 HTTP Client 创建函数

**修改文件：**
- `common/oauth2/exchanger.go`：授权码交换器支持代理
- `common/oauth2/refresher.go`：Token 刷新器支持代理
- `common/oauth2/manager.go`：Token 管理器传递代理配置
- `providers/base/oauth2_provider.go`：OAuth2 Provider Mixin 支持代理参数
- `providers/claude/oauth2_provider.go`：Claude OAuth2 Provider 使用渠道代理配置

#### 2. 代理类型支持

支持以下代理协议：
- **HTTP 代理**：`http://proxy.example.com:8080`
- **HTTPS 代理**：`https://proxy.example.com:8080`
- **SOCKS5 代理**：`socks5://proxy.example.com:1080`

#### 3. 使用方式

##### 方式一：在渠道配置中设置代理

在创建或编辑 Claude OAuth2 渠道时，在"代理"字段中填入代理地址：

```
http://127.0.0.1:7890
```

或

```
socks5://127.0.0.1:1080
```

设置后，该渠道的所有操作（API 请求、Token 刷新）都会通过代理进行。

##### 方式二：使用认证代理

如果代理需要认证，可以在 URL 中包含用户名和密码：

```
http://username:password@proxy.example.com:8080
```

或

```
socks5://username:password@proxy.example.com:1080
```

## 架构说明

### OAuth2 请求流程

```
用户浏览器
    ↓
    ↓ (1) 访问授权页面
    ↓
Claude OAuth2 服务
    ↓
    ↓ (2) 用户授权后返回授权码
    ↓
One Hub 前端
    ↓
    ↓ (3) 提交授权码到 One Hub 后端
    ↓
One Hub 后端 (Exchanger)
    ↓
    ↓ (4) 通过代理交换 token
    ↓
Claude Token 端点 ← (使用渠道代理)
    ↓
    ↓ (5) 返回 refresh_token
    ↓
保存到渠道配置
```

### Token 自动刷新流程

```
API 请求到达
    ↓
检查 access_token 是否过期
    ↓
    ↓ (如果过期)
    ↓
OAuth2 Manager
    ↓
    ↓ 使用渠道代理配置
    ↓
Refresher → Claude Token 端点 ← (使用渠道代理)
    ↓
    ↓ 获取新 token
    ↓
继续处理 API 请求
```

## 注意事项

### 1. 初次授权的代理问题

在前端页面进行 OAuth2 授权时（步骤 1-2），用户的**浏览器需要能够访问 `https://claude.ai`**。如果浏览器无法直接访问，需要：

- 在浏览器中配置代理
- 或使用浏览器插件（如 SwitchyOmega）
- 或使用系统代理

**One Hub 渠道的代理配置不影响浏览器访问**。

### 2. 代理配置生效的操作

渠道代理配置在以下场景生效：

✅ **生效的操作：**
- API 请求（调用 Claude API）
- Token 自动刷新（后台自动进行）
- 手动测试 token 是否有效（如果通过渠道测试功能）

❌ **不生效的操作：**
- 前端获取授权 URL（`GET /api/oauth2/auth_url`）
- 前端授权码交换（`POST /api/oauth2/exchange`）- 这是通用端点
- 前端测试 token（`POST /api/oauth2/test`）- 这是通用端点

对于"不生效"的操作，这些是一次性的配置操作，用户可以：
- 设置系统代理
- 临时使用浏览器代理
- 或在能够访问的网络环境下完成配置

### 3. 代理测试

要测试代理是否生效，可以：

1. **配置渠道时**：在有代理的情况下完成授权流程
2. **运行时测试**：发起 API 请求，检查是否能正常调用
3. **日志检查**：查看应用日志，确认 token 刷新是否成功

### 4. 常见问题

**Q: 我配置了代理，但授权时还是无法访问？**

A: 授权页面访问是在浏览器中进行的，需要在浏览器中配置代理，而不是在 One Hub 中。

**Q: Token 刷新失败，提示网络错误？**

A: 检查渠道的代理配置是否正确，代理服务器是否可用。可以尝试更换代理协议（HTTP/SOCKS5）。

**Q: 使用 SOCKS5 代理需要特殊配置吗？**

A: 不需要，只需在代理地址前加上 `socks5://` 前缀即可。确保代理服务器支持 SOCKS5 协议。

**Q: 代理需要认证怎么办？**

A: 在代理 URL 中包含认证信息，格式：`http://username:password@proxy.example.com:8080`

## 兼容性说明

本次更新完全向后兼容：

- ✅ 未配置代理的渠道继续直连工作
- ✅ 已配置代理的渠道自动使用代理
- ✅ 不影响其他类型的渠道

## 技术细节

### 代理传递链路

```
Channel.Proxy
    ↓
ClaudeOAuth2ProviderFactory.Create()
    ↓
OAuth2ProviderMixin.InitOAuth2WithProxy()
    ↓
oauth2.NewManagerWithProxy()
    ↓
NewDefaultRefresherWithProxy()
    ↓
CreateHTTPClientWithProxy()
    ↓
设置 Transport.Proxy 和 Transport.DialContext
```

### HTTP Client 配置

代理配置通过以下方式注入到 HTTP 请求中：

1. **HTTP/HTTPS 代理**：通过 `http.Transport.Proxy` 函数
2. **SOCKS5 代理**：通过 `http.Transport.DialContext` 函数
3. **Context 传递**：代理地址通过 context 传递到请求中

### 核心代码示例

```go
// 创建带代理的 HTTP Client
client := CreateHTTPClientWithProxy(proxyAddr)

// 在请求中使用代理
ctx = WrapRequestWithProxy(ctx, proxyAddr)
req, _ := http.NewRequestWithContext(ctx, "POST", url, body)
resp, _ := client.Do(req)
```

## 更新日志

### v1.1 (2025-11-20) - 代码简化优化

**优化内容**：
- 新增 `InitOAuth2FromChannel()` 方法，自动从 Channel 读取代理配置
- 简化 Provider 代码，不再需要手动提取代理地址
- API 和 OAuth2 自动使用统一的代理配置

**代码对比**：

*优化前：*
```go
// 需要手动提取代理配置
proxyAddr := ""
if channel.Proxy != nil {
    proxyAddr = *channel.Proxy
}
provider.InitOAuth2WithProxy("claude", channel.Key, proxyAddr)
```

*优化后：*
```go
// 自动从 channel 读取代理配置
provider.InitOAuth2FromChannel("claude", channel)
```

**修改文件**：
- `providers/base/oauth2_provider.go` - 新增 `InitOAuth2FromChannel()` 方法
- `providers/claude/oauth2_provider.go` - 简化代码

---

### v1.0 (2025-11-20) - 初始版本

**新增功能**：
- OAuth2 授权码交换支持代理
- OAuth2 Token 自动刷新支持代理
- 支持 HTTP/HTTPS/SOCKS5 代理协议
- 支持代理认证

**修改文件**：
- `common/oauth2/http_client.go`（新增）
- `common/oauth2/exchanger.go`
- `common/oauth2/refresher.go`
- `common/oauth2/manager.go`
- `providers/base/oauth2_provider.go`
- `providers/claude/oauth2_provider.go`

**API 变更**：
- 新增：`oauth2.NewManagerWithProxy()`
- 新增：`oauth2.NewDefaultExchangerWithProxy()`
- 新增：`oauth2.NewDefaultRefresherWithProxy()`
- 新增：`OAuth2ProviderMixin.InitOAuth2WithProxy()`
- 新增：`OAuth2ProviderMixin.InitOAuth2FromChannel()` (v1.1)
- 保持兼容：所有原有 API 继续可用

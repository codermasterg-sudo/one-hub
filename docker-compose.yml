version: '3.8'

services:
  one-hub:
    image: martialbe/one-api:latest
    container_name: one-hub
    restart: always
    ports:
      - "8001:3000"
    volumes:
      - ./data:/data
    env_file:
      - .env
    environment:
      - SQL_DSN=${SQL_DSN}
      - REDIS_CONN_STRING=${REDIS_CONN_STRING}
      - SESSION_SECRET=${SESSION_SECRET}
      - USER_TOKEN_SECRET=${USER_TOKEN_SECRET}
      - TZ=${TZ}
      - HASHIDS_SALT=${HASHIDS_SALT}
      # 多机部署配置（可选）
      # - NODE_TYPE=${NODE_TYPE}
      # - SYNC_FREQUENCY=${SYNC_FREQUENCY}
      # - FRONTEND_BASE_URL=${FRONTEND_BASE_URL}
      # 代理配置（如需通过 Clash 访问外部 API，取消注释）
      # - HTTP_PROXY=${HTTP_PROXY}
      # - HTTPS_PROXY=${HTTPS_PROXY}
    depends_on:
      - redis
      - db
      - clash
    networks:
      - one-hub-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' | awk -F: '{print $$2}'",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:latest
    container_name: redis
    restart: always
    networks:
      - one-hub-network
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes

  db:
    image: mysql:8.2.0
    restart: always
    container_name: mysql
    volumes:
      - ./data/mysql:/var/lib/mysql
    ports:
      - "3306:3306"
    env_file:
      - .env
    environment:
      - TZ=${TZ}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
    networks:
      - one-hub-network
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  clash:
    image: dreamacro/clash-premium:latest
    container_name: clash
    restart: always
#    ports:
#      - "7890:7890"  # HTTP/HTTPS 代理端口
#      - "7891:7891"  # SOCKS5 代理端口
#      - "9090:9090"  # RESTful API 端口
    volumes:
      - ./clash/config.yaml:/root/.config/clash/config.yaml  # 主配置文件
      - ./clash/subscriptions:/root/.config/clash/subscriptions  # 订阅缓存目录
      - ./clash/ui:/root/.config/clash/ui  # Dashboard UI（可选）
    env_file:
      - .env
    environment:
      - TZ=${TZ}
    networks:
      - one-hub-network
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:9090/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Clash 订阅自动更新服务
  # 每小时自动更新订阅文件，无需手动操作
  clash-subscription-updater:
    build:
      context: ./clash
      dockerfile: Dockerfile.subscription-updater
    container_name: clash-subscription-updater
    restart: always
    volumes:
      - ./clash:/clash-config  # 挂载 clash 配置目录
    env_file:
      - .env
    environment:
      - TZ=${TZ}
    networks:
      - one-hub-network
    depends_on:
      - clash

  # CLIProxyAPI - 轻量级多账号 Claude 代理（推荐）
  # 支持多账号负载均衡，OpenAI/Anthropic 兼容格式
  cliproxy:
    image: eceasy/cli-proxy-api:latest
    container_name: cliproxy
    restart: always
#    ports:
#      - "${CLIPROXY_PORT:-8080}:8080"  # API 端口
    volumes:
      - ./cliproxy/auth:/root/.cli-proxy-api              # 认证凭证目录
      - ./cliproxy/config.yaml:/CLIProxyAPI/config.yaml  # 配置文件
    env_file:
      - .env
    environment:
      - TZ=${TZ}
      # 通过 Clash 代理访问 Claude API
      - HTTP_PROXY=http://clash:7890
      - HTTPS_PROXY=http://clash:7890
    depends_on:
      - clash
    networks:
      - one-hub-network
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  one-hub-network:
    driver: bridge
